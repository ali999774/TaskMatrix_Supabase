<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3b82f6">
  <title>TaskMatrix - Secure</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #dbeafe 100%);
      min-height: 100vh;
      padding: 1.5rem;
    }
    .container { max-width: 1280px; margin: 0 auto; }
    .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
    .status-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; padding: 1rem; }
    .status-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .online { color: #16a34a; }
    .offline { color: #ea580c; }
    .syncing { color: #3b82f6; }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }
    .btn-success { background: #16a34a; color: white; }
    .btn-success:hover { background: #15803d; }
    .btn-purple { background: #9333ea; color: white; }
    .btn-purple:hover { background: #7e22ce; }
    .btn-gray { background: #6b7280; color: white; }
    .btn-gray:hover { background: #4b5563; }
    .btn-red { background: #ef4444; color: white; }
    .btn-red:hover { background: #dc2626; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .stat-card { padding: 1rem; border-radius: 0.5rem; text-align: center; }
    .stat-card.red { background: #fef2f2; color: #991b1b; }
    .stat-card.blue { background: #eff6ff; color: #1e3a8a; }
    .stat-card.yellow { background: #fefce8; color: #854d0e; }
    .stat-card.gray { background: #f9fafb; color: #374151; }
    .stat-number { font-size: 1.5rem; font-weight: bold; }
    .stat-label { font-size: 0.75rem; margin-top: 0.25rem; }
    .progress-bar {
      background: linear-gradient(90deg, #fef9c3 0%, #fed7aa 100%);
      padding: 1rem;
      border-radius: 0.5rem;
      border: 2px solid #fbbf24;
      margin-top: 1rem;
    }
    .progress-track { background: #fde68a; height: 0.75rem; border-radius: 9999px; overflow: hidden; }
    .progress-fill { background: #f59e0b; height: 100%; transition: width 0.5s; }
    .quick-add {
      background: linear-gradient(90deg, #dbeafe 0%, #e9d5ff 100%);
      padding: 1rem;
      border-radius: 0.5rem;
      border: 2px solid #c084fc;
    }
    .quick-add-form { display: flex; gap: 0.75rem; align-items: center; }
    .input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
    }
    .matrix { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .quadrant {
      border-radius: 0.5rem;
      border: 2px solid;
      overflow: hidden;
      transition: all 0.2s;
    }
    .quadrant.drag-over { box-shadow: 0 0 0 4px #3b82f6; }
    .quadrant.red { background: #fef2f2; border-color: #fca5a5; }
    .quadrant.blue { background: #eff6ff; border-color: #93c5fd; }
    .quadrant.yellow { background: #fefce8; border-color: #fde047; }
    .quadrant.gray { background: #f9fafb; border-color: #d1d5db; }
    .quad-header {
      padding: 1rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .quad-header.red { background: #fee2e2; color: #991b1b; }
    .quad-header.blue { background: #dbeafe; color: #1e3a8a; }
    .quad-header.yellow { background: #fef9c3; color: #854d0e; }
    .quad-header.gray { background: #f3f4f6; color: #374151; }
    .quad-body {
      padding: 1rem;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
    }
    .task {
      background: white;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border-left: 4px solid;
      margin-bottom: 0.5rem;
      cursor: move;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }
    .task:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .task.work { border-left-color: #3b82f6; }
    .task.health { border-left-color: #16a34a; }
    .task.learning { border-left-color: #ea580c; }
    .task.personal { border-left-color: #9333ea; }
    .task-content { display: flex; gap: 0.5rem; align-items: center; }
    .task-status-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .task-info { flex: 1; }
    .task-title { font-weight: 500; }
    .task-title.completed { text-decoration: line-through; color: #6b7280; }
    .task-delete {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      font-size: 1.25rem;
      line-height: 1;
      font-weight: 300;
    }
    .task-delete:hover { 
      background: #fee2e2; 
      color: #dc2626;
    }
    .empty-state { text-align: center; color: #9ca3af; padding: 2rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
    
    /* Auth Styles */
    .auth-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    .auth-title {
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .auth-subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 2rem;
      font-size: 0.875rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
      font-size: 0.875rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .auth-btn {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .auth-btn:hover {
      transform: translateY(-2px);
    }
    .auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .auth-switch {
      text-align: center;
      margin-top: 1.5rem;
      color: #6b7280;
      font-size: 0.875rem;
    }
    .auth-link {
      color: #3b82f6;
      cursor: pointer;
      font-weight: 600;
    }
    .auth-link:hover {
      text-decoration: underline;
    }
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: #eff6ff;
      color: #1e40af;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="auth-screen" class="auth-container" style="display: none;">
    <h1 class="auth-title">TaskMatrix</h1>
    <p class="auth-subtitle">Organize your life with the Eisenhower Matrix</p>
    
    <div id="error-message" class="error-message" style="display: none;"></div>
    <div id="success-message" class="success-message" style="display: none;"></div>
    
    <form id="auth-form" onsubmit="handleAuth(event)">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="auth-email" class="form-input" placeholder="you@example.com" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="auth-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
      </div>
      <button type="submit" class="auth-btn" id="auth-btn">
        <span id="auth-btn-text">Sign In</span>
      </button>
    </form>
    
    <div class="auth-switch">
      <span id="auth-switch-text">Don't have an account?</span>
      <span class="auth-link" onclick="toggleAuthMode()">Sign Up</span>
    </div>
  </div>

  <div id="app-screen" class="container" style="display: none;">
    <!-- Status Bar -->
    <div class="card status-bar">
      <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
        <span class="user-badge" id="user-email">üë§ user@example.com</span>
        <div class="status-item" id="online-status">
          <span class="online">‚óè Online</span>
        </div>
        <div class="status-item" id="sync-status">
          <span style="color: #16a34a;">‚òÅÔ∏è Cloud Synced</span>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-primary" id="notif-btn" onclick="enableNotifications()">üîî Notifications</button>
        <button class="btn btn-success" onclick="exportData()">üíæ Export</button>
        <button class="btn btn-gray" id="toggle-completed-btn" onclick="toggleCompletedSection()">üìã Show Completed</button>
        <button class="btn btn-red" onclick="signOut()">üö™ Sign Out</button>
      </div>
    </div>

    <!-- Quick Add -->
    <div class="card quick-add">
      <div class="quick-add-form">
        <input type="text" id="quick-input" class="input" placeholder="‚ö° Quick add (press Enter)..." onkeypress="handleQuickAdd(event)">
        <button class="btn btn-purple" onclick="quickAdd()">Add Task</button>
      </div>
    </div>

    <!-- Matrix -->
    <div class="card">
      <div class="matrix">
        <div class="quadrant red" id="quad-do-first" ondragover="allowDrop(event)" ondrop="drop(event, 'do-first')">
          <div class="quad-header red">
            <span>Do First üî•</span>
            <span id="count-first" style="background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">0</span>
          </div>
          <div class="quad-body" id="tasks-do-first"></div>
        </div>
        
        <div class="quadrant blue" id="quad-schedule" ondragover="allowDrop(event)" ondrop="drop(event, 'schedule')">
          <div class="quad-header blue">
            <span>Schedule üìÖ</span>
            <span id="count-schedule" style="background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">0</span>
          </div>
          <div class="quad-body" id="tasks-schedule"></div>
        </div>
        
        <div class="quadrant yellow" id="quad-delegate" ondragover="allowDrop(event)" ondrop="drop(event, 'delegate')">
          <div class="quad-header yellow">
            <span>Delegate ‚ö°</span>
            <span id="count-delegate" style="background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">0</span>
          </div>
          <div class="quad-body" id="tasks-delegate"></div>
        </div>
        
        <div class="quadrant gray" id="quad-eliminate" ondragover="allowDrop(event)" ondrop="drop(event, 'eliminate')">
          <div class="quad-header gray">
            <span>Eliminate üóëÔ∏è</span>
            <span id="count-eliminate" style="background: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">0</span>
          </div>
          <div class="quad-body" id="tasks-eliminate"></div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="card">
      <h1 style="font-size: 1.875rem; font-weight: bold; margin-bottom: 0.5rem;">TaskMatrix - Secure</h1>
      <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
        üèÜ Level <span id="level">1</span> ‚Ä¢ 
        <span id="xp">0</span>/100 XP ‚Ä¢ 
        <span id="completed">0</span> completed
      </p>
      
      <div class="stats">
        <div class="stat-card red">
          <div class="stat-number" id="stat-first">0</div>
          <div class="stat-label">Do First</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-number" id="stat-schedule">0</div>
          <div class="stat-label">Schedule</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-number" id="stat-delegate">0</div>
          <div class="stat-label">Delegate</div>
        </div>
        <div class="stat-card gray">
          <div class="stat-number" id="stat-eliminate">0</div>
          <div class="stat-label">Eliminate</div>
        </div>
      </div>

      <div class="progress-bar">
        <div style="display: flex; justify-between; margin-bottom: 0.5rem;">
          <span style="font-weight: bold; color: #854d0e;">
            üèÜ Weekly Goal: <span id="weekly-progress">0/10</span> tasks
          </span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Completed Tasks -->
    <div class="card" id="completed-section" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="font-size: 1.5rem; font-weight: bold; color: #374151;">‚úì Completed Tasks</h2>
        <button onclick="clearCompleted()" class="btn btn-red" style="font-size: 0.875rem;">Clear All</button>
      </div>
      <div id="completed-tasks-list" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase Config
    const SUPABASE_URL = 'https://afnpnivrlmckvwilspfh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmbnBuaXZybG1ja3Z3aWxzcGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDY2MDMsImV4cCI6MjA3ODYyMjYwM30.0bFGplQcP4zL6D-3QJIivpY8J1SFwkOIm-p-7Vfsvqg';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // State
    let currentUser = null;
    let tasks = [];
    let userStats = {xp:0, level:1, totalCompleted:0, weeklyGoal:10, weeklyCompleted:0};
    let draggedTask = null;
    let notificationsEnabled = false;
    let showCompleted = false;
    let isSignUp = false;

    // Init
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session) {
        currentUser = session.user;
        showApp();
        await loadUserData();
      } else {
        showAuth();
      }
    }

    function showAuth() {
      document.getElementById('auth-screen').style.display = 'block';
      document.getElementById('app-screen').style.display = 'none';
    }

    function showApp() {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'block';
      document.getElementById('user-email').textContent = 'üë§ ' + currentUser.email;
    }

    function toggleAuthMode() {
      isSignUp = !isSignUp;
      const btnText = document.getElementById('auth-btn-text');
      const switchText = document.getElementById('auth-switch-text');
      
      if (isSignUp) {
        btnText.textContent = 'Sign Up';
        switchText.textContent = 'Already have an account?';
      } else {
        btnText.textContent = 'Sign In';
        switchText.textContent = "Don't have an account?";
      }
      hideMessages();
    }

    async function handleAuth(e) {
      e.preventDefault();
      hideMessages();
      
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      const btn = document.getElementById('auth-btn');
      
      btn.disabled = true;
      btn.textContent = isSignUp ? 'Creating account...' : 'Signing in...';
      
      try {
        if (isSignUp) {
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          showSuccess('Account created! Check your email to verify.');
        } else {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          currentUser = data.user;
          showApp();
          await loadUserData();
        }
      } catch (error) {
        showError(error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
      }
    }

    async function signOut() {
      if (confirm('Sign out?')) {
        await supabase.auth.signOut();
        currentUser = null;
        tasks = [];
        showAuth();
      }
    }

    function showError(msg) {
      const el = document.getElementById('error-message');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function showSuccess(msg) {
      const el = document.getElementById('success-message');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideMessages() {
      document.getElementById('error-message').style.display = 'none';
      document.getElementById('success-message').style.display = 'none';
    }

    async function loadUserData() {
      showSyncStatus('loading');
      try {
        // Load tasks
        const { data: tasksData, error: tasksError } = await supabase
          .from('tasks')
          .select('*')
          .eq('user_id', currentUser.id);
        
        if (tasksError) throw tasksError;
        
        tasks = (tasksData || []).map(t => ({
          id: t.id,
          title: t.title,
          category: t.category,
          status: t.status,
          dueDate: t.due_date,
          importance: t.importance,
          urgency: t.urgency
        }));

        // Load or create stats
        const { data: statsData, error: statsError } = await supabase
          .from('user_stats')
          .select('*')
          .eq('user_id', currentUser.id)
          .single();
        
        if (statsData) {
          userStats = {
            id: statsData.id,
            xp: statsData.xp || 0,
            level: statsData.level || 1,
            totalCompleted: statsData.total_completed || 0,
            weeklyGoal: statsData.weekly_goal || 10,
            weeklyCompleted: statsData.weekly_completed || 0
          };
        } else {
          // Create initial stats
          const { data: newStats } = await supabase
            .from('user_stats')
            .insert([{
              user_id: currentUser.id,
              xp: 0,
              level: 1,
              total_completed: 0,
              weekly_goal: 10,
              weekly_completed: 0
            }])
            .select()
            .single();
          
          if (newStats) {
            userStats.id = newStats.id;
          }
        }

        showSyncStatus('synced');
        render();
      } catch (error) {
        console.error('Load error:', error);
        showSyncStatus('error');
      }
    }

    async function syncTaskToSupabase(task) {
      try {
        const payload = {
          id: task.id,
          user_id: currentUser.id,
          title: task.title,
          category: task.category,
          status: task.status,
          due_date: task.dueDate,
          importance: task.importance,
          urgency: task.urgency
        };

        const { error } = await supabase
          .from('tasks')
          .upsert(payload);

        if (error) throw error;
      } catch (error) {
        console.error('Sync error:', error);
      }
    }

    async function deleteTaskFromSupabase(id) {
      try {
        await supabase
          .from('tasks')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);
      } catch (error) {
        console.error('Delete error:', error);
      }
    }

    async function syncStatsToSupabase() {
      if (!userStats.id) return;
      
      try {
        await supabase
          .from('user_stats')
          .update({
            xp: userStats.xp,
            level: userStats.level,
            total_completed: userStats.totalCompleted,
            weekly_goal: userStats.weeklyGoal,
            weekly_completed: userStats.weeklyCompleted
          })
          .eq('id', userStats.id)
          .eq('user_id', currentUser.id);
      } catch (error) {
        console.error('Stats sync error:', error);
      }
    }

    function showSyncStatus(status) {
      const el = document.getElementById('sync-status');
      if (status === 'loading') {
        el.innerHTML = '<span class="syncing">‚ü≥ Loading...</span>';
      } else if (status === 'syncing') {
        el.innerHTML = '<span class="syncing">‚ü≥ Syncing...</span>';
      } else if (status === 'synced') {
        el.innerHTML = '<span style="color: #16a34a;">‚òÅÔ∏è Synced</span>';
      } else if (status === 'error') {
        el.innerHTML = '<span style="color: #dc2626;">‚ö†Ô∏è Error</span>';
      }
    }

    function getQuad(imp, urg) {
      if (urg >= 4 && imp >= 4) return 'do-first';
      if (urg < 4 && imp >= 4) return 'schedule';
      if (urg >= 4 && imp < 4) return 'delegate';
      return 'eliminate';
    }

    function toggleStatus(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;

      if (task.status === 'todo') {
        task.status = 'in-progress';
      } else if (task.status === 'in-progress') {
        task.status = 'completed';
        awardXP(task);
        if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
          new Notification('Task Completed! üéâ', { body: task.title });
        }
      } else {
        task.status = 'todo';
      }

      syncTaskToSupabase(task);
      render();
      if (showCompleted) renderCompletedTasks();
    }

    function awardXP(task) {
      const quad = getQuad(task.importance, task.urgency);
      let xp = 10;
      if (quad === 'do-first') xp = 50;
      else if (quad === 'schedule') xp = 40;
      else if (quad === 'delegate') xp = 20;

      userStats.xp += xp;
      userStats.level = Math.floor(userStats.xp / 100) + 1;
      userStats.totalCompleted++;
      userStats.weeklyCompleted++;
      syncStatsToSupabase();
    }

    function deleteTask(id) {
      if (confirm('Delete this task?')) {
        tasks = tasks.filter(t => t.id !== id);
        deleteTaskFromSupabase(id);
        render();
        if (showCompleted) renderCompletedTasks();
      }
    }

    function quickAdd() {
      const input = document.getElementById('quick-input');
      const text = input.value.trim();
      if (!text) return;

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);

      const newTask = {
        id: Date.now(),
        title: text,
        category: 'personal',
        status: 'todo',
        dueDate: tomorrow.toISOString().split('T')[0],
        importance: 3,
        urgency: 3,
      };

      tasks.push(newTask);
      syncTaskToSupabase(newTask);
      input.value = '';
      render();
    }

    function handleQuickAdd(e) {
      if (e.key === 'Enter') quickAdd();
    }

    function toggleCompletedSection() {
      showCompleted = !showCompleted;
      const section = document.getElementById('completed-section');
      const btn = document.getElementById('toggle-completed-btn');
      
      if (showCompleted) {
        section.style.display = 'block';
        btn.textContent = 'üìã Hide Completed';
        btn.className = 'btn btn-red';
        renderCompletedTasks();
      } else {
        section.style.display = 'none';
        btn.textContent = 'üìã Show Completed';
        btn.className = 'btn btn-gray';
      }
    }

    function renderCompletedTasks() {
      const completedTasks = tasks.filter(t => t.status === 'completed');
      const container = document.getElementById('completed-tasks-list');
      
      if (completedTasks.length === 0) {
        container.innerHTML = '<div class="empty-state">No completed tasks yet</div>';
        return;
      }
      
      container.innerHTML = completedTasks.map(function(task) {
        return '<div class="task ' + task.category + '" style="opacity: 0.8;"><div class="task-content"><button class="task-status-btn" onclick="toggleStatus(' + task.id + ')"><span style="color: #16a34a; font-size: 1.25rem;">‚úì</span></button><div class="task-info"><div class="task-title completed">' + task.title + '</div></div><button class="task-delete" onclick="deleteTask(' + task.id + ')">√ó</button></div></div>';
      }).join('');
    }

    function clearCompleted() {
      const completedTasks = tasks.filter(t => t.status === 'completed');
      if (completedTasks.length === 0) {
        alert('No completed tasks to clear');
        return;
      }
      
      if (confirm('Delete all ' + completedTasks.length + ' completed tasks?')) {
        completedTasks.forEach(task => deleteTaskFromSupabase(task.id));
        tasks = tasks.filter(t => t.status !== 'completed');
        renderCompletedTasks();
        render();
      }
    }

    function exportData() {
      const data = JSON.stringify({ tasks, userStats }, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'taskmatrix-backup-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function enableNotifications() {
      if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission().then(function(permission) {
          if (permission === 'granted') {
            notificationsEnabled = true;
            document.getElementById('notif-btn').textContent = 'üîî Enabled';
            document.getElementById('notif-btn').disabled = true;
            new Notification('TaskMatrix', { body: 'Notifications enabled!' });
          }
        });
      }
    }

    function drag(e, task) {
      draggedTask = task;
      e.dataTransfer.effectAllowed = 'move';
    }

    function dragEnd() {
      draggedTask = null;
    }

    function allowDrop(e) {
      e.preventDefault();
    }

    function drop(e, quad) {
      e.preventDefault();
      if (!draggedTask) return;

      let imp = 3, urg = 3;
      if (quad === 'do-first') { imp = 5; urg = 5; }
      else if (quad === 'schedule') { imp = 5; urg = 2; }
      else if (quad === 'delegate') { imp = 2; urg = 5; }
      else if (quad === 'eliminate') { imp = 2; urg = 2; }

      const task = tasks.find(t => t.id === draggedTask.id);
      if (task) {
        task.importance = imp;
        task.urgency = urg;
        syncTaskToSupabase(task);
      }

      draggedTask = null;
      render();
    }

    function render() {
      const activeTasks = tasks.filter(t => t.status !== 'completed');
      
      const quadrants = {
        'do-first': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'do-first'),
        'schedule': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'schedule'),
        'delegate': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'delegate'),
        'eliminate': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'eliminate')
      };

      const quadKeys = ['do-first', 'schedule', 'delegate', 'eliminate'];
      for (let i = 0; i < quadKeys.length; i++) {
        const quad = quadKeys[i];
        const container = document.getElementById('tasks-' + quad);
        const countId = quad === 'do-first' ? 'count-first' : 'count-' + quad;
        const count = document.getElementById(countId);
        
        if (!container || !count) continue;
        
        count.textContent = quadrants[quad].length;
        
        if (quadrants[quad].length === 0) {
          container.innerHTML = '<div class="empty-state">Drag tasks here</div>';
        } else {
          let html = '';
          for (let j = 0; j < quadrants[quad].length; j++) {
            const task = quadrants[quad][j];
            const statusIcon = task.status === 'completed' ? '‚úì' : task.status === 'in-progress' ? '‚è±' : '‚óã';
            const statusColor = task.status === 'completed' ? '#16a34a' : task.status === 'in-progress' ? '#3b82f6' : '#9ca3af';
            
            const taskJson = JSON.stringify(task).replace(/"/g, '&quot;');
            html += '<div class="task ' + task.category + '" draggable="true" ondragstart="drag(event, ' + taskJson + ')" ondragend="dragEnd()"><div class="task-content"><button class="task-status-btn" onclick="toggleStatus(' + task.id + ')"><span style="color: ' + statusColor + '; font-size: 1.25rem;">' + statusIcon + '</span></button><div class="task-info"><div class="task-title">' + task.title + '</div></div><button class="task-delete" onclick="deleteTask(' + task.id + ')">√ó</button></div></div>';
          }
          container.innerHTML = html;
        }
      }

      document.getElementById('stat-first').textContent = quadrants['do-first'].length;
      document.getElementById('stat-schedule').textContent = quadrants['schedule'].length;
      document.getElementById('stat-delegate').textContent = quadrants['delegate'].length;
      document.getElementById('stat-eliminate').textContent = quadrants['eliminate'].length;

      document.getElementById('level').textContent = userStats.level;
      document.getElementById('xp').textContent = userStats.xp % 100;
      document.getElementById('completed').textContent = userStats.totalCompleted;
      document.getElementById('weekly-progress').textContent = userStats.weeklyCompleted + '/' + userStats.weeklyGoal;
      
      const progressPercent = Math.min(100, (userStats.weeklyCompleted / userStats.weeklyGoal) * 100);
      document.getElementById('progress-fill').style.width = progressPercent + '%';
    }

    window.addEventListener('online', function() {
      document.getElementById('online-status').innerHTML = '<span class="online">‚óè Online</span>';
    });

    window.addEventListener('offline', function() {
      document.getElementById('online-status').innerHTML = '<span class="offline">‚óè Offline</span>';
    });

    // Initialize
    init();
  </script>
</body>
</html>
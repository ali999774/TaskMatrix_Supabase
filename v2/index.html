<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskMatrix</title>
  <style>
    :root {
      /* Base Colors */
      --bg-body: linear-gradient(135deg, #f8fafc, #dbeafe);
      --bg-card: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.9);
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --text-primary: #111827;
      --text-secondary: #374151;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
      --border-input: #d1d5db;

      /* Brand Colors */
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --primary-light: #eff6ff;
      --primary-dark: #1e40af;

      /* Status Colors */
      --success: #16a34a;
      --success-bg: #dcfce7;
      --warning: #f59e0b;
      --warning-bg: #fffbeb;
      --danger: #ef4444;
      --danger-bg: #fef2f2;

      /* Quadrant Colors */
      --quad-red-bg: #fef2f2;
      --quad-red-border: #fca5a5;
      --quad-red-header: #fee2e2;
      --quad-red-text: #991b1b;

      --quad-blue-bg: #eff6ff;
      --quad-blue-border: #93c5fd;
      --quad-blue-header: #dbeafe;
      --quad-blue-text: #1e3a8a;

      --quad-yellow-bg: #fefce8;
      --quad-yellow-border: #fde047;
      --quad-yellow-header: #fef9c3;
      --quad-yellow-text: #854d0e;

      --quad-gray-bg: #f9fafb;
      --quad-gray-border: #d1d5db;
      --quad-gray-header: #f3f4f6;
      --quad-gray-text: #374151;

      /* Note Colors */
      --note-yellow-bg: #fef9c3;
      --note-yellow-border: #fde047;
      --note-pink-bg: #fce7f3;
      --note-pink-border: #f9a8d4;
      --note-blue-bg: #dbeafe;
      --note-blue-border: #93c5fd;
      --note-green-bg: #d1fae5;
      --note-green-border: #6ee7b7;
      --note-purple-bg: #e9d5ff;
      --note-purple-border: #c084fc;

      /* Note Category Colors */
      --cat-ideas-bg: #fef9c3;
      --cat-ideas-border: #fde047;
      --cat-tasks-bg: #dbeafe;
      --cat-tasks-border: #93c5fd;
      --cat-reference-bg: #e9d5ff;
      --cat-reference-border: #c084fc;
      --cat-notes-bg: #f3f4f6;
      --cat-notes-border: #d1d5db;
      --cat-quick-bg: #fed7aa;
      --cat-quick-border: #fb923c;
    }

    [data-theme="dark"] {
      /* Base Colors */
      --bg-body: linear-gradient(135deg, #0f172a, #1e293b);
      --bg-card: #1e293b;
      --bg-glass: rgba(30, 41, 59, 0.9);
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #f9fafb;
      --text-secondary: #e2e8f0;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --border-input: #475569;

      /* Brand Colors */
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --primary-light: rgba(59, 130, 246, 0.1);
      --primary-dark: #93c5fd;

      /* Status Colors */
      --success: #4ade80;
      --success-bg: rgba(22, 163, 74, 0.2);
      --warning: #fbbf24;
      --warning-bg: rgba(245, 158, 11, 0.2);
      --danger: #f87171;
      --danger-bg: rgba(239, 68, 68, 0.2);

      /* Quadrant Colors */
      --quad-red-bg: rgba(153, 27, 27, 0.1);
      --quad-red-border: #7f1d1d;
      --quad-red-header: rgba(153, 27, 27, 0.2);
      --quad-red-text: #fca5a5;

      --quad-blue-bg: rgba(30, 58, 138, 0.1);
      --quad-blue-border: #1e3a8a;
      --quad-blue-header: rgba(30, 58, 138, 0.2);
      --quad-blue-text: #93c5fd;

      --quad-yellow-bg: rgba(133, 77, 14, 0.1);
      --quad-yellow-border: #713f12;
      --quad-yellow-header: rgba(133, 77, 14, 0.2);
      --quad-yellow-text: #fde047;

      --quad-gray-bg: rgba(55, 65, 81, 0.1);
      --quad-gray-border: #4b5563;
      --quad-gray-header: rgba(55, 65, 81, 0.2);
      --quad-gray-text: #d1d5db;

      /* Note Colors */
      --note-yellow-bg: rgba(254, 249, 195, 0.1);
      --note-yellow-border: #854d0e;
      --note-pink-bg: rgba(252, 231, 243, 0.1);
      --note-pink-border: #831843;
      --note-blue-bg: rgba(219, 234, 254, 0.1);
      --note-blue-border: #1e40af;
      --note-green-bg: rgba(209, 250, 229, 0.1);
      --note-green-border: #065f46;
      --note-purple-bg: rgba(233, 213, 255, 0.1);
      --note-purple-border: #6b21a8;

      /* Note Category Colors */
      --cat-ideas-bg: rgba(254, 249, 195, 0.1);
      --cat-ideas-border: #854d0e;
      --cat-tasks-bg: rgba(219, 234, 254, 0.1);
      --cat-tasks-border: #1e40af;
      --cat-reference-bg: rgba(233, 213, 255, 0.1);
      --cat-reference-border: #6b21a8;
      --cat-notes-bg: rgba(55, 65, 81, 0.1);
      --cat-notes-border: #4b5563;
      --cat-quick-bg: rgba(254, 215, 170, 0.1);
      --cat-quick-border: #c2410c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      min-height: 100vh;
      padding-top: 70px;
      padding-bottom: 24px;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Top Bar */
    .zen-top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      z-index: 100;
      padding: 12px 24px;
    }

    .zen-top-content {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .zen-logo {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-dark);
      white-space: nowrap;
    }

    .quick-add-input {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      min-width: 200px;
    }

    .quick-add-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .zen-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .status-indicator {
      width: 24px;
      height: 24px;
      background: var(--success);
      border-radius: 50%;
      border: 2px solid var(--bg-card);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 0 0 2px var(--success-bg);
    }

    .status-indicator:hover {
      transform: scale(1.1);
    }

    .zen-icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      color: var(--text-muted);
      font-size: 20px;
      line-height: 1;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .zen-icon-btn:hover {
      background: var(--quad-gray-bg);
      color: var(--text-secondary);
    }

    /* Status Dropdown */
    .status-dropdown {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      min-width: 300px;
      z-index: 200;
      display: none;
      margin-top: 8px;
      padding: 16px;
    }

    .status-dropdown.show {
      display: block;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    /* Menu Dropdown */
    .menu-dropdown {
      position: relative;
    }

    .menu-dropdown-content {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      z-index: 200;
      display: none;
      margin-top: 8px;
    }

    .menu-dropdown-content.show {
      display: block;
    }

    .menu-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .menu-item:hover {
      background: var(--quad-gray-bg);
    }

    .menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    /* Floating Badges */
    .floating-badges {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 90;
    }

    @media (max-width: 768px) {
      .floating-badges {
        bottom: 16px;
        right: 16px;
        gap: 10px;
      }
    }

    .floating-badge {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
    }

    .floating-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .floating-badge.stats {
      background: var(--quad-yellow-header);
      border-color: var(--warning);
      position: fixed;
      right: 24px;
      bottom: 200px;
    }

    .floating-badge.notes {
      background: var(--quad-blue-header);
      border-color: var(--primary);
      position: fixed;
      right: 24px;
      bottom: 120px;
    }

    @media (max-width: 768px) {
      .floating-badge {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }

      .floating-badge.stats { right: 16px; bottom: 180px; }
      .floating-badge.notes { right: 16px; bottom: 100px; }
    }

    /* Stats Popup */
    .stats-popup {
      position: fixed;
      bottom: 100px;
      right: 24px;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      padding: 20px;
      min-width: 320px;
      z-index: 95;
      display: none;
    }

    .stats-popup.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stats-popup-header {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-dark);
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stats-grid-popup {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-box-popup {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-box-popup.red {
      background: var(--quad-red-bg);
      color: var(--quad-red-text);
    }

    .stat-box-popup.blue {
      background: var(--quad-blue-bg);
      color: var(--quad-blue-text);
    }

    .stat-box-popup.yellow {
      background: var(--quad-yellow-bg);
      color: var(--quad-yellow-text);
    }

    .stat-box-popup.gray {
      background: var(--quad-gray-bg);
      color: var(--quad-gray-text);
    }

    .stat-number-popup {
      font-size: 24px;
      font-weight: bold;
    }

    .stat-label-popup {
      font-size: 11px;
      margin-top: 4px;
    }

    .xp-bar {
      background: var(--border-color);
      height: 8px;
      border-radius: 9999px;
      overflow: hidden;
      margin: 8px 0;
    }

    .xp-fill {
      background: linear-gradient(90deg, var(--primary), #8b5cf6);
      height: 100%;
      transition: width 0.5s;
    }

    .weekly-bar {
      background: var(--warning-bg);
      height: 8px;
      border-radius: 9999px;
      overflow: hidden;
      margin: 8px 0;
    }

    .weekly-fill {
      background: var(--warning);
      height: 100%;
      transition: width 0.5s;
    }

    /* Search */
    .search-container {
      background: var(--bg-card);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .search-container.collapsed {
      max-height: 0;
      margin-bottom: 0;
      opacity: 0;
    }

    .search-container.expanded {
      max-height: 200px;
      opacity: 1;
    }

    .search-content {
      padding: 16px;
    }

    .search-filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-input,
    .filter-select {
      padding: 10px 12px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 14px;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
    }

    .clear-btn {
      padding: 10px 16px;
      background: var(--quad-gray-bg);
      color: var(--text-primary);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .clear-btn:hover {
      background: var(--border-color);
    }

    /* Matrix */
    .card {
      background: var(--bg-card);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 0;
      margin-bottom: 24px;
    }

    .matrix {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      padding: 24px;
    }

    @media (max-width: 768px) {
      .matrix {
        grid-template-columns: 1fr;
      }
    }

    .quadrant {
      border-radius: 8px;
      border: 2px solid;
      overflow: hidden;
    }

    .quadrant.red {
      background: var(--quad-red-bg);
      border-color: var(--quad-red-border);
    }

    .quadrant.blue {
      background: var(--quad-blue-bg);
      border-color: var(--quad-blue-border);
    }

    .quadrant.yellow {
      background: var(--quad-yellow-bg);
      border-color: var(--quad-yellow-border);
    }

    .quadrant.gray {
      background: var(--quad-gray-bg);
      border-color: var(--quad-gray-border);
    }

    .quad-header {
      padding: 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quad-header.red {
      background: var(--quad-red-header);
      color: var(--quad-red-text);
    }

    .quad-header.blue {
      background: var(--quad-blue-header);
      color: var(--quad-blue-text);
    }

    .quad-header.yellow {
      background: var(--quad-yellow-header);
      color: var(--quad-yellow-text);
    }

    .quad-header.gray {
      background: var(--quad-gray-header);
      color: var(--quad-gray-text);
    }

    .quad-body {
      padding: 16px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Tasks */
    .task {
      background: var(--bg-card);
      padding: 8px 12px;
      border-radius: 8px;
      border-left: 4px solid;
      margin-bottom: 8px;
      cursor: move;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      position: relative;
      color: var(--text-primary);
    }

    .task.work {
      border-left-color: var(--primary);
    }

    .task.health {
      border-left-color: var(--success);
    }

    .task.learning {
      border-left-color: #ea580c;
    }

    .task.personal {
      border-left-color: #9333ea;
    }

    .task.overdue {
      border-left-width: 6px;
      border-left-color: var(--danger) !important;
      background: var(--danger-bg);
    }

    .task.due-today {
      border-left-width: 6px;
      border-left-color: var(--warning) !important;
      background: var(--warning-bg);
    }

    .task.due-soon {
      border-left-width: 6px;
      border-left-color: var(--primary) !important;
      background: var(--primary-light);
    }

    .task.pinned {
      border-top: 3px solid var(--warning);
    }

    .task-content {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .task-info {
      flex: 1;
      cursor: pointer;
    }

    .task-info:hover {
      opacity: 0.8;
    }

    .task-title {
      font-weight: 500;
    }

    .task-title.completed {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .due-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .due-badge.overdue {
      background: var(--quad-red-header);
      color: var(--quad-red-text);
    }

    .due-badge.today {
      background: var(--quad-yellow-header);
      color: var(--quad-yellow-text);
    }

    .due-badge.soon {
      background: var(--quad-blue-header);
      color: var(--quad-blue-text);
    }

    .recurring-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 32px;
    }

    button.pin-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .task:hover button.pin-btn {
      opacity: 1;
    }

    button.pin-btn.pinned {
      opacity: 1;
      color: var(--warning);
    }

    button.pin-btn:hover {
      color: var(--warning);
    }

    button.icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--text-muted);
      font-size: 20px;
      line-height: 1;
    }

    button.icon-btn:hover {
      color: var(--text-secondary);
    }

    /* Sort Dropdown */
    .sort-dropdown {
      position: relative;
      display: inline-block;
    }

    .sort-dropdown-btn {
      background: var(--bg-card);
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 16px;
      color: var(--text-muted);
      line-height: 1;
    }

    .sort-dropdown-btn:hover {
      background: var(--quad-gray-bg);
    }

    .sort-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      min-width: 150px;
      z-index: 100;
      display: none;
      margin-top: 4px;
    }

    .sort-dropdown-menu.show {
      display: block;
    }

    .sort-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .sort-dropdown-item:hover {
      background: var(--quad-gray-bg);
    }

    .sort-dropdown-item.active {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .sort-dropdown-item .checkmark {
      visibility: hidden;
    }

    .sort-dropdown-item.active .checkmark {
      visibility: visible;
    }

    /* Completed Section */
    .completed-section {
      background: var(--bg-card);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 24px;
      display: none;
    }

    .completed-section.show {
      display: block;
    }

    /* Notes Modal */
    .notes-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .notes-modal.active {
      display: flex;
    }

    .notes-container {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .notes-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notes-title {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .notes-header-actions {
      display: flex;
      gap: 12px;
    }

    .notes-body {
      padding: 24px;
    }

    .notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .note-card {
      padding: 16px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      position: relative;
      min-height: 120px;
      max-height: 200px;
      overflow: hidden;
    }

    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .note-card:hover .note-delete-btn {
      opacity: 1;
    }

    .note-delete-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 10;
    }

    .note-delete-btn:hover {
      transform: scale(1.1);
      background: rgba(220, 38, 38, 1);
    }

    .note-card.yellow {
      background: var(--note-yellow-bg);
      border: 2px solid var(--note-yellow-border);
    }

    .note-card.pink {
      background: var(--note-pink-bg);
      border: 2px solid var(--note-pink-border);
    }

    .note-card.blue {
      background: var(--note-blue-bg);
      border: 2px solid var(--note-blue-border);
    }

    .note-card.green {
      background: var(--note-green-bg);
      border: 2px solid var(--note-green-border);
    }

    .note-card.purple {
      background: var(--note-purple-bg);
      border: 2px solid var(--note-purple-border);
    }

    .note-card-header {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .note-card-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .note-card-footer {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 12px;
    }

    .new-note-btn {
      padding: 40px;
      border: 2px dashed var(--border-input);
      border-radius: 12px;
      background: var(--quad-gray-bg);
      cursor: pointer;
      text-align: center;
      color: var(--text-muted);
      font-size: 16px;
      transition: all 0.2s;
    }

    .new-note-btn:hover {
      background: var(--border-color);
      border-color: var(--text-muted);
      color: var(--text-secondary);
    }

    .notes-search {
      padding: 12px 16px;
      border: 2px solid var(--border-input);
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      margin-top: 16px;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .notes-search:focus {
      outline: none;
      border-color: var(--primary);
    }

    .pinned-notes-section {
      margin-top: 0;
      display: none;
      padding: 24px;
      border-top: 1px solid var(--border-color);
    }

    .pinned-notes-section.has-notes {
      display: block;
    }

    .pinned-notes-header {
      font-size: 20px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pinned-notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }

    /* Note Edit Modal */
    .modal-overlay,
    .note-edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.active,
    .note-edit-modal.active {
      opacity: 1;
      pointer-events: auto;
      z-index: 1001;
    }

    .note-edit-container {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .note-edit-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .note-edit-body {
      padding: 24px;
    }

    .note-title-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .note-title-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .note-content-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      min-height: 200px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.6;
    }

    .note-content-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .note-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px;
      background: var(--quad-gray-bg);
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-input);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar-btn:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    .note-preview {
      padding: 12px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      min-height: 200px;
      line-height: 1.6;
      font-size: 14px;
    }

    .note-preview ul {
      margin-left: 20px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .note-preview li {
      margin-bottom: 4px;
    }

    .note-preview input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }

    .note-preview .checked-item {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .note-preview ol {
      margin-left: 20px;
      margin-top: 8px;
      margin-bottom: 8px;
      list-style-type: decimal;
    }

    .note-preview p {
      margin-bottom: 8px;
    }

    .note-preview h3, .note-preview h4 {
      margin-top: 12px;
      margin-bottom: 8px;
    }

    .view-toggle {
      display: flex;
      gap: 4px;
      background: var(--quad-gray-bg);
      padding: 4px;
      border-radius: 6px;
    }

    .view-toggle-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .view-toggle-btn.active {
      background: var(--bg-card);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .category-selector {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .category-selector-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      width: 100%;
      margin-bottom: 4px;
    }

    .category-btn {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 2px solid var(--border-input);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .category-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .category-btn.selected {
      border-width: 3px;
      font-weight: 600;
    }

    .category-btn.ideas {
      border-color: var(--cat-ideas-border);
      background: var(--cat-ideas-bg);
    }

    .category-btn.tasks {
      border-color: var(--cat-tasks-border);
      background: var(--cat-tasks-bg);
    }

    .category-btn.reference {
      border-color: var(--cat-reference-border);
      background: var(--cat-reference-bg);
    }

    .category-btn.notes {
      border-color: var(--cat-notes-border);
      background: var(--cat-notes-bg);
    }

    .category-btn.quick {
      border-color: var(--cat-quick-border);
      background: var(--cat-quick-bg);
    }

    .note-category-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 18px;
      opacity: 0.7;
    }

    .notes-filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      padding: 12px;
      background: var(--quad-gray-bg);
      border-radius: 8px;
    }

    .filter-tab {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 2px solid var(--border-input);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .filter-tab:hover {
      background: var(--primary-light);
    }

    .filter-tab.active {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .color-picker {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      align-items: center;
    }

    .color-picker-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-right: 8px;
    }

    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: var(--primary-dark);
    }

    .color-option.yellow {
      background: var(--note-yellow-bg);
      border: 1px solid var(--note-yellow-border);
    }

    .color-option.pink {
      background: var(--note-pink-bg);
      border: 1px solid var(--note-pink-border);
    }

    .color-option.blue {
      background: var(--note-blue-bg);
      border: 1px solid var(--note-blue-border);
    }

    .color-option.green {
      background: var(--note-green-bg);
      border: 1px solid var(--note-green-border);
    }

    .color-option.purple {
      background: var(--note-purple-bg);
      border: 1px solid var(--note-purple-border);
    }

    .note-edit-footer {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .note-info {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 16px;
      padding: 12px;
      background: var(--quad-gray-bg);
      border-radius: 8px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 16px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }

    .slider-value {
      font-weight: bold;
      color: var(--primary);
      min-width: 30px;
      text-align: center;
    }

    .tag-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 2px solid var(--border-input);
      background: var(--bg-card);
      border-radius: 8px;
      min-height: 42px;
      cursor: text;
    }

    .tag {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag-remove {
      background: none;
      border: none;
      color: var(--primary-dark);
      cursor: pointer;
      font-weight: bold;
      padding: 0;
      line-height: 1;
    }

    .tag-input {
      border: none;
      outline: none;
      flex: 1;
      min-width: 100px;
      padding: 4px;
    }

    .subtask-list {
      margin-top: 8px;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--quad-gray-bg);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .subtask-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .subtask-text {
      flex: 1;
      font-size: 14px;
    }

    .subtask-text.completed {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .subtask-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .subtask-delete:hover {
      color: var(--danger);
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-gray {
      background: var(--text-muted);
      color: white;
    }

    .btn-gray:hover {
      background: var(--text-secondary);
    }

    .btn-red {
      background: var(--danger);
      color: white;
    }

    .btn-red:hover {
      background: #dc2626;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #15803d;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      background: var(--quad-gray-bg);
      border-radius: 8px;
      margin-top: 16px;
    }

    .info-item {
      font-size: 12px;
      color: var(--text-muted);
    }

    .info-value {
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .empty-notes {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-notes-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-notes-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-notes-subtext {
      font-size: 14px;
    }

    /* Pomodoro */
    .pomodoro-pill {
      position: fixed;
      bottom: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      z-index: 1200;
      cursor: default;
      min-width: 220px;
    }
    .pomodoro-pill-left {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .pomodoro-pill-icon {
      font-size: 16px;
    }
    .pomodoro-pill-time {
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .pomodoro-pill-btn {
      border: none;
      background: var(--btn-primary-bg);
      color: white;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .pomodoro-pill-btn:hover { transform: translateY(-1px); }
    .pomodoro-pill.paused { border-color: var(--warning); }
    .pomodoro-pill .pomodoro-notice {
      font-size: 12px;
      color: var(--text-secondary);
      margin-left: 6px;
    }
    .pomodoro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1300;
      padding: 16px;
    }
    .pomodoro-overlay.active { display: flex; }
    .pomodoro-modal {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 18px;
      padding: 22px;
      width: 360px;
      box-shadow: 0 18px 36px rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
    }
    .pomodoro-modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .pomodoro-mode-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .pomodoro-circle {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 16px auto;
    }
    .pomodoro-circle svg {
      transform: rotate(-90deg);
    }
    .pomodoro-time-remaining {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
    }
    .pomodoro-time-remaining span {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      margin-top: 4px;
    }
    .pomodoro-primary-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      background: var(--btn-primary-bg);
      color: white;
      cursor: pointer;
      margin: 6px 0 10px;
    }
    .pomodoro-session-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 8px 0 6px;
    }
    .pomodoro-session-dots span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border-color);
    }
    .pomodoro-session-dots span.active {
      background: var(--success);
    }
    .pomodoro-modal-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
    }
    .pomodoro-link-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
    }
    .pomodoro-settings {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 16px;
      padding: 18px;
      width: 340px;
      box-shadow: 0 18px 36px rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
    }
    .pomodoro-setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .pomodoro-setting-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pomodoro-setting-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      cursor: pointer;
      font-weight: 700;
    }
    .pomodoro-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pomodoro-toggle input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .pomodoro-settings-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 6px;
    }
    .pomodoro-secondary-btn {
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
  
  <!-- Top Bar -->
  <div class="zen-top-bar">
    <div class="zen-top-content">
      <div class="zen-logo">üìä TaskMatrix</div>
      <input type="text" id="quick-add-input" class="quick-add-input" placeholder="‚ö° Quick add task (press Enter)..."
        onkeypress="handleQuickAdd(event)">
      <div class="zen-actions">
        <button class="zen-icon-btn" onclick="toggleTheme()" title="Toggle Dark Mode" id="theme-toggle">üåô</button>
        <div style="position: relative;">
          <div class="status-indicator" onclick="toggleStatusDropdown(event)" title="Online"></div>
          <div class="status-dropdown" id="status-dropdown">
            <div class="status-item">
              <div class="status-dot"></div><strong>Online</strong>
            </div>
            <div class="status-item" id="sync-status-label">‚úì Synced with Local Storage</div>
            <div class="status-item" style="color: #6b7280; font-size: 12px;" id="sync-status-text">Last sync: Just now</div>
          </div>
        </div>
        <button class="zen-icon-btn" onclick="toggleSearch()" title="Search & Filter">üîç</button>
        <div class="menu-dropdown">
          <button class="zen-icon-btn" onclick="toggleMenu(event)">‚ãÆ</button>
          <div class="menu-dropdown-content" id="main-menu">
            <button class="menu-item" onclick="document.getElementById('import-file').click(); closeMenu()">üì• Import
              Data</button>
            <button class="menu-item" onclick="exportData(); closeMenu()">üì§ Export Data</button>
            <button class="menu-item" onclick="toggleCompletedSection(); closeMenu()">üìã <span
                id="menu-completed-text">Show Completed</span></button>
            <button class="menu-item" onclick="openAuthModal('signin'); closeMenu()" id="auth-menu-signin">üîê Sign In / Sign Up</button>
            <button class="menu-item" onclick="handleSignOut(); closeMenu()" id="auth-menu-signout" style="display:none;">üö™ Sign Out</button>
            <button class="menu-item" onclick="showAbout(); closeMenu()">‚ÑπÔ∏è About</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Badges -->
  <div class="floating-badges">
    <div class="floating-badge stats" id="stats-badge" title="View Stats">
      üèÜ
    </div>
    <div class="floating-badge notes" id="notes-badge" title="Quick Notes">
      üìù
    </div>
  </div>

  <!-- Stats Popup -->
  <div class="stats-popup" id="stats-popup">
    <div class="stats-popup-header">
      üèÜ Your Progress
      <button class="modal-close" onclick="closeStatsPopup()" style="font-size: 20px;">√ó</button>
    </div>
    <div style="margin-bottom: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <span style="font-size: 14px; font-weight: 600;">Level <span id="popup-level">1</span></span>
        <span style="font-size: 12px; color: #6b7280;"><span id="popup-xp">0</span>/100 XP</span>
      </div>
      <div class="xp-bar">
        <div class="xp-fill" id="popup-xp-fill" style="width: 0%"></div>
      </div>
    </div>
    <div style="margin-bottom: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <span style="font-size: 14px; font-weight: 600;">Weekly Goal</span>
        <span style="font-size: 12px; color: #6b7280;"><span id="popup-weekly">0/10</span></span>
      </div>
      <div class="weekly-bar">
        <div class="weekly-fill" id="popup-weekly-fill" style="width: 0%"></div>
      </div>
    </div>
    <div class="stats-grid-popup">
      <div class="stat-box-popup red">
        <div class="stat-number-popup" id="popup-stat-first">0</div>
        <div class="stat-label-popup">Do First</div>
      </div>
      <div class="stat-box-popup blue">
        <div class="stat-number-popup" id="popup-stat-schedule">0</div>
        <div class="stat-label-popup">Schedule</div>
      </div>
      <div class="stat-box-popup yellow">
        <div class="stat-number-popup" id="popup-stat-delegate">0</div>
        <div class="stat-label-popup">Delegate</div>
      </div>
      <div class="stat-box-popup gray">
        <div class="stat-number-popup" id="popup-stat-eliminate">0</div>
        <div class="stat-label-popup">Eliminate</div>
      </div>
    </div>
    <div style="text-align: center; font-size: 12px; color: #6b7280; margin-top: 8px;">
      <span id="popup-completed">0</span> tasks completed
    </div>
  </div>

  <div class="container">
    <!-- Collapsible Search -->
    <div class="search-container collapsed" id="search-container">
      <div class="search-content">
        <div class="search-filter-bar">
          <input type="text" id="search-input" class="search-input" placeholder="üîé Search tasks..."
            oninput="applyFilters()">
          <select id="filter-category" class="filter-select" onchange="applyFilters()">
            <option value="all">All Categories</option>
            <option value="work">Work</option>
            <option value="personal">Personal</option>
            <option value="health">Health</option>
            <option value="learning">Learning</option>
          </select>
          <select id="filter-status" class="filter-select" onchange="applyFilters()">
            <option value="all">All Status</option>
            <option value="todo">To Do</option>
            <option value="in-progress">In Progress</option>
          </select>
          <select id="filter-date" class="filter-select" onchange="applyFilters()">
            <option value="all">All Dates</option>
            <option value="overdue">Overdue</option>
            <option value="today">Due Today</option>
            <option value="week">Due This Week</option>
          </select>
          <button class="clear-btn" onclick="clearFilters()">Clear</button>
        </div>
      </div>
    </div>

    <!-- Completed Section -->
    <div class="completed-section" id="completed-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="font-size:20px; font-weight:bold; color:var(--text-secondary);">‚úì Completed Tasks</h2>
        <button onclick="clearCompleted()" class="btn btn-red">Clear All</button>
      </div>
      <div id="completed-tasks-list" style="max-height:300px; overflow-y:auto;"></div>
    </div>

    <!-- Matrix -->
    <div class="card">
      <div class="matrix">
        <div class="quadrant red" ondragover="allowDrop(event)" ondrop="drop(event, 'do-first')">
          <div class="quad-header red">
            <span>Do First üî•</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <span id="count-first" style="background:white; padding:4px 8px; border-radius:4px;">0</span>
              <div class="sort-dropdown">
                <button class="sort-dropdown-btn" onclick="toggleSortDropdown('do-first', event)">‚ãÆ</button>
                <div class="sort-dropdown-menu" id="sort-menu-do-first">
                  <button class="sort-dropdown-item active" onclick="setSortMode('do-first', 'manual', event)"><span
                      class="checkmark">‚úì</span><span>‚úã Manual</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('do-first', 'date', event)"><span
                      class="checkmark">‚úì</span><span>üìÖ Date</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('do-first', 'alpha', event)"><span
                      class="checkmark">‚úì</span><span>üî§ A-Z</span></button>
                </div>
              </div>
            </div>
          </div>
          <div class="quad-body" id="tasks-do-first"></div>
        </div>

        <div class="quadrant blue" ondragover="allowDrop(event)" ondrop="drop(event, 'schedule')">
          <div class="quad-header blue">
            <span>Schedule üìÖ</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <span id="count-schedule" style="background:white; padding:4px 8px; border-radius:4px;">0</span>
              <div class="sort-dropdown">
                <button class="sort-dropdown-btn" onclick="toggleSortDropdown('schedule', event)">‚ãÆ</button>
                <div class="sort-dropdown-menu" id="sort-menu-schedule">
                  <button class="sort-dropdown-item active" onclick="setSortMode('schedule', 'manual', event)"><span
                      class="checkmark">‚úì</span><span>‚úã Manual</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('schedule', 'date', event)"><span
                      class="checkmark">‚úì</span><span>üìÖ Date</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('schedule', 'alpha', event)"><span
                      class="checkmark">‚úì</span><span>üî§ A-Z</span></button>
                </div>
              </div>
            </div>
          </div>
          <div class="quad-body" id="tasks-schedule"></div>
        </div>

        <div class="quadrant yellow" ondragover="allowDrop(event)" ondrop="drop(event, 'delegate')">
          <div class="quad-header yellow">
            <span>Delegate ü§ù</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <span id="count-delegate" style="background:white; padding:4px 8px; border-radius:4px;">0</span>
              <div class="sort-dropdown">
                <button class="sort-dropdown-btn" onclick="toggleSortDropdown('delegate', event)">‚ãÆ</button>
                <div class="sort-dropdown-menu" id="sort-menu-delegate">
                  <button class="sort-dropdown-item active" onclick="setSortMode('delegate', 'manual', event)"><span
                      class="checkmark">‚úì</span><span>‚úã Manual</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('delegate', 'date', event)"><span
                      class="checkmark">‚úì</span><span>üìÖ Date</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('delegate', 'alpha', event)"><span
                      class="checkmark">‚úì</span><span>üî§ A-Z</span></button>
                </div>
              </div>
            </div>
          </div>
          <div class="quad-body" id="tasks-delegate"></div>
        </div>

        <div class="quadrant gray" ondragover="allowDrop(event)" ondrop="drop(event, 'eliminate')">
          <div class="quad-header gray">
            <span>Eliminate üóëÔ∏è</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <span id="count-eliminate" style="background:white; padding:4px 8px; border-radius:4px;">0</span>
              <div class="sort-dropdown">
                <button class="sort-dropdown-btn" onclick="toggleSortDropdown('eliminate', event)">‚ãÆ</button>
                <div class="sort-dropdown-menu" id="sort-menu-eliminate">
                  <button class="sort-dropdown-item active"
                    onclick="setSortMode('eliminate', 'manual', event)"><span class="checkmark">‚úì</span><span>‚úã
                      Manual</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('eliminate', 'date', event)"><span
                      class="checkmark">‚úì</span><span>üìÖ Date</span></button>
                  <button class="sort-dropdown-item" onclick="setSortMode('eliminate', 'alpha', event)"><span
                      class="checkmark">‚úì</span><span>üî§ A-Z</span></button>
                </div>
              </div>
            </div>
          </div>
          <div class="quad-body" id="tasks-eliminate"></div>
        </div>
      </div>
    </div>

    <!-- Pinned Notes Section -->
    <div class="pinned-notes-section" id="pinned-notes-section">
      <div class="pinned-notes-header">
        <span>üìå Pinned Notes</span>
      </div>
      <div class="pinned-notes-grid" id="pinned-notes-grid"></div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div class="notes-modal" id="notes-modal" onclick="closeNotesModalOnOverlay(event)">
    <div class="notes-container" onclick="event.stopPropagation()">
      <div class="notes-header">
        <h2 class="notes-title">üìù Quick Notes</h2>
        <div class="notes-header-actions">
          <button class="btn btn-primary" onclick="createNewNote()">+ New Note</button>
          <button class="modal-close" onclick="closeNotesModal()">√ó</button>
        </div>
      </div>
      <div class="notes-body">
        <div class="notes-filter-tabs">
          <button class="filter-tab active" data-category="all" onclick="filterNotesByCategory('all')">üìã All</button>
          <button class="filter-tab" data-category="ideas" onclick="filterNotesByCategory('ideas')">üí° Ideas</button>
          <button class="filter-tab" data-category="tasks" onclick="filterNotesByCategory('tasks')">‚úÖ Tasks</button>
          <button class="filter-tab" data-category="reference" onclick="filterNotesByCategory('reference')">üìö Reference</button>
          <button class="filter-tab" data-category="notes" onclick="filterNotesByCategory('notes')">üìù Notes</button>
          <button class="filter-tab" data-category="quick" onclick="filterNotesByCategory('quick')">‚ö° Quick</button>
        </div>
        <div class="notes-grid" id="notes-grid"></div>
        <input type="text" id="notes-search" class="notes-search" placeholder="üîç Search notes..."
          oninput="filterNotes()">
      </div>
    </div>
  </div>

  <!-- Note Edit Modal -->
  <div class="note-edit-modal" id="note-edit-modal" onclick="closeNoteEditModalOnOverlay(event)">
    <div class="note-edit-container" onclick="event.stopPropagation()">
      <div class="note-edit-header">
        <h2 style="font-size: 20px; font-weight: bold;">Edit Note</h2>
        <button class="modal-close" onclick="closeNoteEditModal()">√ó</button>
      </div>
      <div class="note-edit-body">
        <input type="text" id="note-title-input" class="note-title-input"
          placeholder="üìå Note title...">
        
        <div class="category-selector">
          <div class="category-selector-label">Category:</div>
          <button class="category-btn ideas" data-category="ideas" id="cat-ideas">
            <span>üí°</span><span>Ideas</span>
          </button>
          <button class="category-btn tasks" data-category="tasks" id="cat-tasks">
            <span>‚úÖ</span><span>Tasks</span>
          </button>
          <button class="category-btn reference" data-category="reference" id="cat-reference">
            <span>üìö</span><span>Reference</span>
          </button>
          <button class="category-btn notes selected" data-category="notes" id="cat-notes">
            <span>üìù</span><span>Notes</span>
          </button>
          <button class="category-btn quick" data-category="quick" id="cat-quick">
            <span>‚ö°</span><span>Quick</span>
          </button>
        </div>

        <div class="view-toggle">
          <button class="view-toggle-btn active" id="edit-view-btn">‚úèÔ∏è Edit</button>
          <button class="view-toggle-btn" id="preview-view-btn">üëÅÔ∏è Preview</button>
        </div>

        <div id="note-edit-area">
          <div class="note-toolbar">
            <button class="toolbar-btn" id="bullet-btn" title="Bullet list">‚Ä¢ Bullet</button>
            <button class="toolbar-btn" id="checkbox-btn" title="Checklist">‚òê Checkbox</button>
            <button class="toolbar-btn" id="numbered-btn" title="Numbered list">1. Numbered</button>
            <button class="toolbar-btn" id="heading-btn" title="Heading"># Heading</button>
            <button class="toolbar-btn" id="bold-btn" title="Bold"><strong>B</strong></button>
            <button class="toolbar-btn" id="italic-btn" title="Italic"><em>I</em></button>
          </div>
          <textarea id="note-content-input" class="note-content-input"
            placeholder="Write your note here...

Tips:
‚Ä¢ Type '- ' for bullets
‚Ä¢ Type '[ ] ' for checkboxes
‚Ä¢ Type '1. ' for numbered lists
‚Ä¢ Type '# ' for headings" onkeydown="handleNoteKeydown(event)"></textarea>
        </div>

        <div id="note-preview-area" style="display: none;">
          <div class="note-preview" id="note-preview-content"></div>
        </div>

        <div class="color-picker">
          <span class="color-picker-label">Color:</span>
          <div class="color-option yellow" onclick="selectNoteColor('yellow')"></div>
          <div class="color-option pink" onclick="selectNoteColor('pink')"></div>
          <div class="color-option blue" onclick="selectNoteColor('blue')"></div>
          <div class="color-option green" onclick="selectNoteColor('green')"></div>
          <div class="color-option purple" onclick="selectNoteColor('purple')"></div>
        </div>
        <div class="note-info">
          <div>Created: <span id="note-created-date">-</span></div>
          <div>Last edited: <span id="note-edited-date">-</span></div>
        </div>
        <div style="margin-top: 16px; display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="note-pinned-input" style="width: 16px; height: 16px; cursor: pointer;">
          <label for="note-pinned-input" style="cursor: pointer; font-size: 14px; color: var(--text-secondary);">Pin
            this note to dashboard</label>
        </div>
      </div>
      <div class="note-edit-footer">
        <button class="btn btn-red" id="delete-note-btn" onclick="deleteCurrentNote()">üóëÔ∏è Delete</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-success" onclick="convertNoteToTask()">‚ûï Convert to Task</button>
          <button class="btn btn-primary" onclick="saveCurrentNote()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="task-modal" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-main-title">Add Task</h2>
        <button class="modal-close" onclick="closeTaskModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" id="modal-title" class="form-input" placeholder="Task title">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea id="modal-notes" class="form-textarea" placeholder="Add detailed notes..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select id="modal-category" class="form-input">
            <option value="work">Work</option>
            <option value="personal">Personal</option>
            <option value="health">Health</option>
            <option value="learning">Learning</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date & Time</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <input type="date" id="modal-date" class="form-input">
            <input type="time" id="modal-time" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Importance</label>
          <div class="slider-container">
            <input type="range" id="modal-importance" class="slider" min="1" max="5" value="3"
              oninput="updateSliderValue('importance')">
            <span class="slider-value" id="importance-value">3</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Urgency</label>
          <div class="slider-container">
            <input type="range" id="modal-urgency" class="slider" min="1" max="5" value="3"
              oninput="updateSliderValue('urgency')">
            <span class="slider-value" id="urgency-value">3</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div class="tag-input-container" id="tag-container" onclick="focusTagInput()">
            <input type="text" id="tag-input" class="tag-input" placeholder="Add tags..."
              onkeypress="handleTagInput(event)">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Subtasks</label>
          <div class="subtask-list" id="subtask-list"></div>
          <input type="text" id="subtask-input" class="form-input" placeholder="Add subtask (press Enter)"
            onkeypress="handleSubtaskInput(event)" style="margin-top:8px;">
        </div>
        <div class="form-group">
          <label class="form-label">Estimated Duration (minutes)</label>
          <input type="number" id="modal-duration" class="form-input" placeholder="e.g., 30" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Recurring Task</label>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <input type="checkbox" id="modal-recurring" style="width: 20px; height: 20px; cursor: pointer;"
              onchange="toggleRecurringOptions()">
            <label for="modal-recurring" style="margin: 0; cursor: pointer; font-weight: normal;">Make this a
              recurring
              task</label>
          </div>
          <div id="recurring-options"
            style="display: none; padding: 16px; background: var(--quad-gray-bg); border-radius: 8px; margin-top: 8px;">
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 14px; margin-bottom: 8px; font-weight: 600;">Repeat
                Every</label>
              <select id="modal-recur-frequency" class="form-input" onchange="updateRecurringUI()">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div id="custom-days-input" style="display: none; margin-bottom: 12px;">
              <label style="display: block; font-size: 14px; margin-bottom: 8px;">Every <input type="number"
                  id="modal-recur-interval" min="1" value="1"
                  style="width: 60px; padding: 4px 8px; border: 2px solid var(--border-input); border-radius: 4px; text-align: center; background: var(--bg-card); color: var(--text-primary);">
                day(s)</label>
            </div>
            <div id="weekdays-input" style="display: none;">
              <label style="display: block; font-size: 14px; margin-bottom: 8px; font-weight: 600;">Repeat
                On</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="1" class="weekday-check"> Mon
                </label>
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="2" class="weekday-check"> Tue
                </label>
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="3" class="weekday-check"> Wed
                </label>
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="4" class="weekday-check"> Thu
                </label>
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="5" class="weekday-check"> Fri
                </label>
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="6" class="weekday-check"> Sat
                </label>
                <label
                  style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-card); border: 2px solid var(--border-input); border-radius: 6px; cursor: pointer; font-weight: normal;">
                  <input type="checkbox" value="0" class="weekday-check"> Sun
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="info-grid" id="task-info-grid" style="display: none;">
          <div class="info-item">
            <div>Created</div>
            <div class="info-value" id="modal-created">-</div>
          </div>
          <div class="info-item">
            <div>Last Modified</div>
            <div class="info-value" id="modal-modified">-</div>
          </div>
          <div class="info-item">
            <div>Status</div>
            <div class="info-value" id="modal-status">-</div>
          </div>
          <div class="info-item">
            <div>Quadrant</div>
            <div class="info-value" id="modal-quadrant">-</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-red" id="delete-task-btn" onclick="deleteTaskFromModal()"
          style="display: none;">Delete
          Task</button>
        <div style="display:flex; gap:8px; margin-left: auto;">
          <button class="btn btn-gray" onclick="closeTaskModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveTaskDetails()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal-overlay" id="auth-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="auth-modal-title">Sign In</div>
        <button class="modal-close" onclick="closeAuthModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="auth-message" style="display:none; padding:12px; border-radius:8px; margin-bottom:12px;"></div>
        <div class="form-group">
          <label class="form-label" for="auth-email">Email</label>
          <input type="email" id="auth-email" class="form-input" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label class="form-label" for="auth-password">Password</label>
          <input type="password" id="auth-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="auth-submit-btn" onclick="submitAuth()">Sign In</button>
        <button class="btn btn-gray" id="auth-toggle-btn" onclick="toggleAuthMode()" style="margin-left:auto;">Need an account? Sign Up</button>
        <button class="btn btn-red" id="auth-signout-btn" onclick="handleSignOut()" style="display:none;">Sign Out</button>
      </div>
    </div>
  </div>

  <!-- Pomodoro Pill -->
  <div class="pomodoro-pill" id="pomodoro-pill">
    <div class="pomodoro-pill-left" id="pomodoro-open-btn">
      <span class="pomodoro-pill-icon" id="pomodoro-pill-icon">‚è±</span>
      <span class="pomodoro-pill-time" id="pomodoro-pill-time">20:00</span>
      <span class="pomodoro-notice" id="pomodoro-pill-note"></span>
    </div>
    <button class="pomodoro-pill-btn" id="pomodoro-pill-action">Start</button>
  </div>

  <!-- Full Pomodoro Modal -->
  <div class="pomodoro-overlay" id="pomodoro-modal">
    <div class="pomodoro-modal">
      <div class="pomodoro-modal-title" id="pomodoro-modal-title">Focus Session</div>
      <div class="pomodoro-mode-label" id="pomodoro-mode-label">Work</div>
      <div class="pomodoro-circle">
        <svg width="200" height="200">
          <circle cx="100" cy="100" r="90" stroke="var(--border-color)" stroke-width="12" fill="none"></circle>
          <circle id="pomodoro-progress" cx="100" cy="100" r="90" stroke="var(--primary)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
        </svg>
        <div class="pomodoro-time-remaining">
          <div id="pomodoro-modal-time">20:00</div>
          <span id="pomodoro-modal-subtext">Work session</span>
        </div>
      </div>
      <button class="pomodoro-primary-btn" id="pomodoro-modal-action">Start</button>
      <div class="pomodoro-session-dots" id="pomodoro-session-dots">
        <span></span><span></span><span></span><span></span>
      </div>
      <div class="pomodoro-modal-actions">
        <button class="pomodoro-link-btn" onclick="closePomodoroModal()">‚úï Close</button>
        <button class="pomodoro-link-btn" onclick="openPomodoroSettings()">‚öô Settings</button>
      </div>
    </div>
  </div>

  <!-- Pomodoro Settings Modal -->
  <div class="pomodoro-overlay" id="pomodoro-settings-modal">
    <div class="pomodoro-settings">
      <div class="pomodoro-modal-title">Pomodoro Settings</div>
      <div class="pomodoro-setting-row">
        <span>Work length (min)</span>
        <div class="pomodoro-setting-controls">
          <button class="pomodoro-setting-btn" data-setting="workLength" data-delta="-1">-</button>
          <span id="setting-workLength">20</span>
          <button class="pomodoro-setting-btn" data-setting="workLength" data-delta="1">+</button>
        </div>
      </div>
      <div class="pomodoro-setting-row">
        <span>Short break (min)</span>
        <div class="pomodoro-setting-controls">
          <button class="pomodoro-setting-btn" data-setting="shortBreakLength" data-delta="-1">-</button>
          <span id="setting-shortBreakLength">5</span>
          <button class="pomodoro-setting-btn" data-setting="shortBreakLength" data-delta="1">+</button>
        </div>
      </div>
      <div class="pomodoro-setting-row">
        <span>Long break (min)</span>
        <div class="pomodoro-setting-controls">
          <button class="pomodoro-setting-btn" data-setting="longBreakLength" data-delta="-1">-</button>
          <span id="setting-longBreakLength">15</span>
          <button class="pomodoro-setting-btn" data-setting="longBreakLength" data-delta="1">+</button>
        </div>
      </div>
      <div class="pomodoro-setting-row pomodoro-toggle">
        <span>Auto start break</span>
        <input type="checkbox" id="setting-autoStartBreak">
      </div>
      <div class="pomodoro-setting-row pomodoro-toggle">
        <span>Show seconds</span>
        <input type="checkbox" id="setting-showSeconds">
      </div>
      <div class="pomodoro-settings-actions">
        <button class="pomodoro-secondary-btn" onclick="closePomodoroSettings()">Cancel</button>
        <button class="pomodoro-primary-btn" style="margin:0; width:auto;" onclick="savePomodoroSettings()">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { supabaseClient, initSupabaseAuth, signOutCurrentUser, getCurrentUserId } from './supabaseAuth.js';
    const supabase = supabaseClient;

    let currentUser = null;
    let authMode = 'signin';
    let isSyncing = false;
    let lastSyncedAt = null;
    let tasks = [];
    let notes = [];
    let userStats = { xp: 0, level: 1, totalCompleted: 0, weeklyGoal: 10, weeklyCompleted: 0 };
    let draggedTask = null;
    let showCompleted = false;
    let currentEditingTask = null;
    let currentFocusTaskId = null;
    let currentEditingNote = null;
    let currentNoteColor = 'yellow';
    let currentNoteCategory = 'notes';
    let noteCategoryFilter = 'all';
    let noteViewMode = 'edit'; // 'edit' or 'preview'
    let sortModes = { 'do-first': 'manual', 'schedule': 'manual', 'delegate': 'manual', 'eliminate': 'manual' };
    let filters = { search: '', category: 'all', status: 'all', date: 'all' };
    let pendingTaskSyncQueue = [];
    const defaultPomodoroSettings = {
      workLength: 20,
      shortBreakLength: 5,
      longBreakLength: 15,
      autoStartBreak: true,
      showSeconds: true
    };
    let pomodoroSettings = { ...defaultPomodoroSettings };
    let pomodoroSettingsDraft = null;
    let pomodoroState = {
      mode: 'work',
      remainingSeconds: defaultPomodoroSettings.workLength * 60,
      isRunning: false,
      intervalId: null,
      workSessionsCompletedInCycle: 0,
      notice: ''
    };
    let hasLoadedInitialData = false;
    let pendingNoteSync = false;
    let pendingTaskSyncAfterCurrentSync = false;
    let pendingNoteSyncQueued = false;

    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const btn = document.getElementById('theme-toggle');
      if (btn) btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function initPomodoro() {
      try {
        const saved = localStorage.getItem('pomodoroSettings');
        if (saved) {
          pomodoroSettings = { ...defaultPomodoroSettings, ...JSON.parse(saved) };
        } else {
          pomodoroSettings = { ...defaultPomodoroSettings };
        }
      } catch (e) {
        pomodoroSettings = { ...defaultPomodoroSettings };
      }

      pomodoroState.mode = 'work';
      pomodoroState.remainingSeconds = pomodoroSettings.workLength * 60;
      pomodoroState.isRunning = false;
      pomodoroState.workSessionsCompletedInCycle = 0;
      pomodoroState.notice = '';

      const pillAction = document.getElementById('pomodoro-pill-action');
      const pillOpen = document.getElementById('pomodoro-open-btn');
      const modalAction = document.getElementById('pomodoro-modal-action');
      const settingsModal = document.getElementById('pomodoro-settings-modal');
      const pomodoroModal = document.getElementById('pomodoro-modal');
      const autoStart = document.getElementById('setting-autoStartBreak');
      const showSeconds = document.getElementById('setting-showSeconds');

      if (pillAction) pillAction.onclick = handlePomodoroAction;
      if (modalAction) modalAction.onclick = handlePomodoroAction;
      if (pillOpen) pillOpen.onclick = openPomodoroModal;
      document.querySelectorAll('.pomodoro-setting-btn').forEach(btn => {
        btn.onclick = () => adjustPomodoroSetting(btn.dataset.setting, parseInt(btn.dataset.delta, 10));
      });
      if (autoStart) autoStart.onchange = () => handlePomodoroToggle('autoStartBreak', autoStart.checked);
      if (showSeconds) showSeconds.onchange = () => handlePomodoroToggle('showSeconds', showSeconds.checked);

      if (pomodoroModal) {
        pomodoroModal.addEventListener('click', (e) => { if (e.target.id === 'pomodoro-modal') closePomodoroModal(); });
      }
      if (settingsModal) {
        settingsModal.addEventListener('click', (e) => { if (e.target.id === 'pomodoro-settings-modal') closePomodoroSettings(); });
      }

      updatePomodoroSettingsUI();
      updatePomodoroUI();
    }

    function handlePomodoroAction() {
      if (pomodoroState.isRunning) {
        pausePomodoro();
      } else {
        startPomodoro();
      }
    }

    function startPomodoro() {
      if (pomodoroState.intervalId) clearInterval(pomodoroState.intervalId);
      pomodoroState.isRunning = true;
      pomodoroState.notice = '';
      pomodoroState.intervalId = setInterval(pomodoroTick, 1000);
      updatePomodoroUI();
    }

    function pausePomodoro() {
      if (pomodoroState.intervalId) clearInterval(pomodoroState.intervalId);
      pomodoroState.intervalId = null;
      pomodoroState.isRunning = false;
      updatePomodoroUI();
    }

    function pomodoroTick() {
      if (!pomodoroState.isRunning) return;
      if (pomodoroState.remainingSeconds > 0) {
        pomodoroState.remainingSeconds -= 1;
        updatePomodoroUI();
        return;
      }
      handlePomodoroCompletion();
    }

    function handlePomodoroCompletion() {
      pausePomodoro();
      if (pomodoroState.mode === 'work') {
        pomodoroState.workSessionsCompletedInCycle = Math.min(4, pomodoroState.workSessionsCompletedInCycle + 1);
        logPomodoroWork(pomodoroSettings.workLength);
        const nextMode = pomodoroState.workSessionsCompletedInCycle >= 3 ? 'longBreak' : 'shortBreak';
        startNextPomodoroSession(nextMode, pomodoroSettings.autoStartBreak);
      } else {
        const nextMode = 'work';
        if (pomodoroState.mode === 'longBreak') {
          pomodoroState.workSessionsCompletedInCycle = 0;
        }
        startNextPomodoroSession(nextMode, true);
      }
    }

    function startNextPomodoroSession(mode, autoStart) {
      pomodoroState.mode = mode;
      pomodoroState.remainingSeconds = getPomodoroDuration(mode);
      pomodoroState.notice = (mode !== 'work' && !autoStart) ? 'Work session done. Start break?' : '';
      updatePomodoroUI();
      if (autoStart || mode === 'work') {
        startPomodoro();
      }
    }

    function getPomodoroDuration(mode) {
      if (mode === 'shortBreak') return pomodoroSettings.shortBreakLength * 60;
      if (mode === 'longBreak') return pomodoroSettings.longBreakLength * 60;
      return pomodoroSettings.workLength * 60;
    }

    function formatPomodoroTime(seconds) {
      const settingsForDisplay = getActivePomodoroSettings();
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      if (!settingsForDisplay.showSeconds) return `${Math.max(mins, 0)}m`;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updatePomodoroUI() {
      const pill = document.getElementById('pomodoro-pill');
      const pillIcon = document.getElementById('pomodoro-pill-icon');
      const pillTime = document.getElementById('pomodoro-pill-time');
      const pillBtn = document.getElementById('pomodoro-pill-action');
      const pillNote = document.getElementById('pomodoro-pill-note');
      const modalTitle = document.getElementById('pomodoro-modal-title');
      const modalLabel = document.getElementById('pomodoro-mode-label');
      const modalTime = document.getElementById('pomodoro-modal-time');
      const modalSub = document.getElementById('pomodoro-modal-subtext');
      const modalAction = document.getElementById('pomodoro-modal-action');
      const progress = document.getElementById('pomodoro-progress');
      const dots = document.querySelectorAll('#pomodoro-session-dots span');

      const total = getPomodoroDuration(pomodoroState.mode);
      const ratio = total === 0 ? 0 : (pomodoroState.remainingSeconds / total);
      const dashArray = 2 * Math.PI * 90;
      if (progress) {
        progress.setAttribute('stroke-dasharray', dashArray.toFixed(2));
        progress.setAttribute('stroke-dashoffset', ((1 - ratio) * dashArray).toFixed(2));
        progress.setAttribute('stroke', pomodoroState.mode === 'work' ? 'var(--primary)' : 'var(--success)');
      }

      const icon = pomodoroState.isRunning
        ? (pomodoroState.mode === 'work' ? '‚óè' : '‚óã')
        : '‚è±';
      const actionLabel = pomodoroState.isRunning ? 'Pause' : (pomodoroState.remainingSeconds === total ? 'Start' : 'Resume');

      if (pillIcon) pillIcon.textContent = icon;
      if (pillTime) pillTime.textContent = formatPomodoroTime(pomodoroState.remainingSeconds);
      if (pillBtn) pillBtn.textContent = actionLabel;
      if (pillNote) pillNote.textContent = pomodoroState.notice;
      if (pill) {
        pill.classList.toggle('paused', !pomodoroState.isRunning && pomodoroState.remainingSeconds !== total);
      }

      const focusTitle = getFocusTitle();
      if (modalTitle) modalTitle.textContent = focusTitle;
      if (modalLabel) modalLabel.textContent = pomodoroState.mode === 'work' ? 'Work' : (pomodoroState.mode === 'shortBreak' ? 'Short Break' : 'Long Break');
      if (modalTime) modalTime.textContent = formatPomodoroTime(pomodoroState.remainingSeconds);
      if (modalSub) modalSub.textContent = pomodoroState.mode === 'work' ? 'Stay focused' : 'Take a breather';
      if (modalAction) modalAction.textContent = actionLabel.toUpperCase();

      if (dots && dots.length) {
        dots.forEach((d, idx) => {
          d.classList.toggle('active', idx < pomodoroState.workSessionsCompletedInCycle);
        });
      }
    }

    function getFocusTitle() {
      if (!currentFocusTaskId) return 'Focus Session';
      const task = tasks.find(t => t.id === currentFocusTaskId);
      return task ? task.title : 'Focus Session';
    }

    function openPomodoroModal() {
      const modal = document.getElementById('pomodoro-modal');
      if (modal) modal.classList.add('active');
      updatePomodoroUI();
    }

    function closePomodoroModal() {
      const modal = document.getElementById('pomodoro-modal');
      if (modal) modal.classList.remove('active');
    }

    function openPomodoroSettings() {
      const modal = document.getElementById('pomodoro-settings-modal');
      pomodoroSettingsDraft = { ...pomodoroSettings };
      if (modal) modal.classList.add('active');
      updatePomodoroSettingsUI();
    }

    function closePomodoroSettings() {
      const modal = document.getElementById('pomodoro-settings-modal');
      if (modal) modal.classList.remove('active');
      pomodoroSettingsDraft = null;
    }

    function updatePomodoroSettingsUI() {
      const source = getActivePomodoroSettings();
      const fields = ['workLength', 'shortBreakLength', 'longBreakLength'];
      fields.forEach(key => {
        const span = document.getElementById(`setting-${key}`);
        if (span) span.textContent = source[key];
      });
      const autoStart = document.getElementById('setting-autoStartBreak');
      const showSeconds = document.getElementById('setting-showSeconds');
      if (autoStart) autoStart.checked = source.autoStartBreak;
      if (showSeconds) showSeconds.checked = source.showSeconds;
    }

    function adjustPomodoroSetting(key, delta) {
      const target = pomodoroSettingsDraft || pomodoroSettings;
      const next = Math.max(1, (target[key] || 1) + delta);
      target[key] = next;
      updatePomodoroSettingsUI();
    }

    function handlePomodoroToggle(key, value) {
      const target = pomodoroSettingsDraft || pomodoroSettings;
      target[key] = value;
      updatePomodoroSettingsUI();
      if (key === 'showSeconds') updatePomodoroUI();
    }

    function savePomodoroSettings() {
      const target = pomodoroSettingsDraft || pomodoroSettings;
      pomodoroSettings = { ...defaultPomodoroSettings, ...target };
      pomodoroSettingsDraft = null;
      localStorage.setItem('pomodoroSettings', JSON.stringify(pomodoroSettings));
      pomodoroState.remainingSeconds = getPomodoroDuration(pomodoroState.mode);
      updatePomodoroUI();
      closePomodoroSettings();
    }

    function getActivePomodoroSettings() {
      return pomodoroSettingsDraft || pomodoroSettings;
    }

    function logPomodoroWork(minutes) {
      if (!currentFocusTaskId) return;
      try {
        const log = JSON.parse(localStorage.getItem('pomodoroLog') || '{}');
        const current = log[currentFocusTaskId] || 0;
        log[currentFocusTaskId] = current + minutes;
        localStorage.setItem('pomodoroLog', JSON.stringify(log));
        console.log('Pomodoro work logged', { taskId: currentFocusTaskId, minutes: minutes });
      } catch (e) {
        console.log('Pomodoro log skipped', e);
      }
    }

    function loadNotesFromLocalStorage() {
      try {
        const saved = localStorage.getItem('notes');
        if (saved) {
          const parsedNotes = JSON.parse(saved);
          if (Array.isArray(parsedNotes)) {
            notes = parsedNotes;
          }
        }
        // Always render notes after loading (even if empty array)
        renderNotes();
        renderPinnedNotes();
      } catch (err) {
        console.error('Failed to load notes from local storage', err);
        // Ensure notes is still an array even on error
        if (!Array.isArray(notes)) notes = [];
        renderNotes();
        renderPinnedNotes();
      }
    }

    function bindUIEventHandlers() {
      const themeToggleBtn = document.getElementById('theme-toggle');
      if (themeToggleBtn) themeToggleBtn.onclick = () => toggleTheme();

      const statusBtn = document.querySelector('.status-indicator');
      if (statusBtn) statusBtn.onclick = (e) => toggleStatusDropdown(e);

      const menuBtn = document.querySelector('.menu-dropdown > button');
      if (menuBtn) menuBtn.onclick = (e) => toggleMenu(e);

      const quickAddInput = document.getElementById('quick-add-input');
      if (quickAddInput) quickAddInput.onkeypress = (e) => handleQuickAdd(e);

      const authSubmitBtn = document.getElementById('auth-submit-btn');
      if (authSubmitBtn) authSubmitBtn.onclick = (e) => { e.preventDefault(); submitAuth(); };

      ['auth-email', 'auth-password'].forEach(id => {
        const field = document.getElementById(id);
        if (field) {
          field.onkeypress = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              submitAuth();
            }
          };
        }
      });
    }

    async function init() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      const savedNotes = localStorage.getItem('notes');
      if (savedNotes) {
        try {
          notes = JSON.parse(savedNotes);
        } catch (e) {
          console.error('Failed to parse saved notes', e);
          notes = [];
        }
      }
      if (typeof renderNotes === 'function') {
        renderNotes();
      }
      if (typeof renderPinnedNotes === 'function') {
        renderPinnedNotes();
      }

      bindUIEventHandlers();

      await initSupabaseAuth({
        onSignedIn: async (user) => {
          currentUser = user;
          updateAuthUI();
          await syncFromSupabase();
          hasLoadedInitialData = true;
        },
        onSignedOut: () => {
          hasLoadedInitialData = false;
          resetUserState(); // renders local data if any
          authMode = 'signin';
          refreshAuthModeUI();
          updateAuthUI();
          updateSyncStatus('synced');
          openAuthModal('signin');
        }
      });

      initPomodoro();
      if (typeof window !== 'undefined') {
        window.addEventListener('online', flushPendingTaskSync);
        window.addEventListener('online', flushPendingNoteSync);
      }

      if (typeof renderNotes === 'function') {
        renderNotes();
      }
      if (typeof renderPinnedNotes === 'function') {
        renderPinnedNotes();
      }
    }

    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
      if (currentUser) {
        if (navigator.onLine && !isSyncing) {
          pendingTaskSyncQueue = [];
          syncTasksToSupabase().catch(console.error);
          syncUserDataToSupabase().catch(console.error);
        } else {
          enqueueTaskSync(tasks);
          pendingTaskSyncAfterCurrentSync = true;
        }
      }
    }
    function saveStats() {
      localStorage.setItem('userStats', JSON.stringify(userStats));
      if (currentUser && !isSyncing) {
        syncStatsToSupabase().catch(console.error);
        syncUserDataToSupabase().catch(console.error);
      }
    }
    function saveNotes() {
      try {
        localStorage.setItem('notes', JSON.stringify(notes));
      } catch (e) {
        console.error('Failed to save notes', e);
      }
    }

    // --- Notes timestamp helpers for cross-device sync ---
    function getLocalNotesTimestamp() {
      try {
        const ts = localStorage.getItem('notes_updated_at');
        return ts ? parseInt(ts, 10) : 0;
      } catch (e) {
        return 0;
      }
    }

    function setLocalNotesTimestamp(ts) {
      try {
        localStorage.setItem('notes_updated_at', String(ts));
      } catch (e) {
        console.error('Failed to save notes timestamp', e);
      }
    }

    function touchLocalNotesTimestamp() {
      setLocalNotesTimestamp(Date.now());
    }

    function saveNotesAndSync() {
      // Notes are local-only - just save to localStorage
      saveNotes();
    }

    function enqueueTaskSync(taskList = tasks) {
      if (!currentUser) return;
      const userId = currentUser.id;
      if (!userId) return;
      const rows = (taskList || [])
        .map(task => taskToSupabaseRow(task, userId))
        .filter(row => row !== null); // Filter out any null rows
      pendingTaskSyncQueue = rows;
      updateSyncStatus('synced', 'Queued for sync when online');
    }

    async function flushPendingTaskSync() {
      if (!currentUser || !currentUser.id) {
        // Clear queue if no user - don't flush with old user_id
        pendingTaskSyncQueue = [];
        return;
      }
      if (!pendingTaskSyncQueue.length) return;
      
      // Don't block on queue flush - run in background
      const queueToFlush = [...pendingTaskSyncQueue];
      pendingTaskSyncQueue = [];
      
      try {
        const userId = currentUser.id; // Always use current user's ID
        
        // Ensure all rows have the current user's user_id (don't use old user_id from queue)
        const rows = queueToFlush.map(row => ({
          ...row,
          user_id: userId // Always use current user's ID
        }));
        
        const { error } = await supabase.from('tasks').upsert(rows);
        if (error) throw error;
        
        // Only update status if we're not already syncing (to avoid interrupting main sync)
        if (!isSyncing) {
          updateSyncStatus('synced');
        }
      } catch (err) {
        console.error('Flush task queue error', err);
        // Only re-queue if we still have a current user
        if (currentUser && currentUser.id) {
          pendingTaskSyncQueue = [...queueToFlush, ...pendingTaskSyncQueue];
        }
        // Only update status if we're not already syncing
        if (!isSyncing) {
          updateSyncStatus('error', err.message || 'Queue flush failed');
        }
      }
    }

    async function flushPendingNoteSync() {
      if (!pendingNoteSyncQueued) return;
      if (!currentUser || !navigator.onLine) return;
      pendingNoteSyncQueued = false;
      pendingNoteSync = false;
      try {
        await syncUserDataToSupabase();
        updateSyncStatus('synced');
      } catch (err) {
        console.error('Flush note sync error', err);
        pendingNoteSyncQueued = true;
        pendingNoteSync = true;
        updateSyncStatus('error', err.message || 'Note sync failed');
      }
    }

    function updateSyncStatus(state, message = '') {
      const statusLabel = document.getElementById('sync-status-label');
      const statusText = document.getElementById('sync-status-text');
      const indicator = document.querySelector('.status-indicator');
      if (state === 'loading') {
        isSyncing = true;
        if (statusLabel) statusLabel.textContent = '‚ü≥ Loading...';
        if (statusText) statusText.textContent = message || 'Loading cloud data...';
        if (indicator) indicator.style.boxShadow = '0 0 0 2px var(--primary)';
      } else if (state === 'syncing') {
        isSyncing = true;
        if (statusLabel) statusLabel.textContent = '‚ü≥ Syncing...';
        if (statusText) statusText.textContent = message || 'Working...';
        if (indicator) indicator.style.boxShadow = '0 0 0 2px var(--primary)';
      } else if (state === 'synced') {
        isSyncing = false;
        lastSyncedAt = new Date();
        if (statusLabel) statusLabel.textContent = currentUser ? '‚òÅÔ∏è Supabase synced' : '‚úì Synced with Local Storage';
        if (statusText && lastSyncedAt) statusText.textContent = 'Last sync: ' + lastSyncedAt.toLocaleTimeString();
        if (indicator) indicator.style.boxShadow = '0 0 0 2px var(--success-bg)';
      } else if (state === 'error') {
        isSyncing = false;
        if (statusLabel) statusLabel.textContent = '‚ö†Ô∏è Sync issue';
        if (statusText) statusText.textContent = message || 'Check your connection';
        if (indicator) indicator.style.boxShadow = '0 0 0 2px var(--danger)';
      }
    }

    function updateAuthUI() {
      const signedIn = !!currentUser;
      const signInBtn = document.getElementById('auth-menu-signin');
      const signOutBtn = document.getElementById('auth-menu-signout');
      const modalSignOut = document.getElementById('auth-signout-btn');
      const submitBtn = document.getElementById('auth-submit-btn');
      const title = document.getElementById('auth-modal-title');
      if (signInBtn) signInBtn.style.display = signedIn ? 'none' : 'block';
      if (signOutBtn) signOutBtn.style.display = signedIn ? 'block' : 'none';
      if (modalSignOut) modalSignOut.style.display = signedIn ? 'inline-block' : 'none';
      if (submitBtn) submitBtn.style.display = signedIn ? 'none' : 'inline-block';
      if (title) title.textContent = signedIn ? 'Account' : (authMode === 'signup' ? 'Sign Up' : 'Sign In');
      if (!signedIn) refreshAuthModeUI();
      const indicator = document.querySelector('.status-indicator');
      if (indicator) indicator.style.background = signedIn ? 'var(--success)' : '#f59e0b';
      const statusLabel = document.getElementById('sync-status-label');
      if (statusLabel) statusLabel.textContent = signedIn ? '‚òÅÔ∏è Supabase connected' : '‚úì Local mode';
    }

    function setAuthMessage(text, type = 'info') {
      const msg = document.getElementById('auth-message');
      if (!msg) return;
      msg.style.display = text ? 'block' : 'none';
      msg.style.background = type === 'error' ? 'var(--danger-bg)' : 'var(--success-bg)';
      msg.style.color = type === 'error' ? 'var(--danger)' : 'var(--success)';
      msg.textContent = text || '';
    }

    function refreshAuthModeUI() {
      const submitBtn = document.getElementById('auth-submit-btn');
      const toggleBtn = document.getElementById('auth-toggle-btn');
      const title = document.getElementById('auth-modal-title');
      if (submitBtn) submitBtn.textContent = authMode === 'signup' ? 'Sign Up' : 'Sign In';
      if (toggleBtn) toggleBtn.textContent = authMode === 'signup' ? 'Have an account? Sign In' : 'Need an account? Sign Up';
      if (title) title.textContent = authMode === 'signup' ? 'Sign Up' : 'Sign In';
      setAuthMessage('');
    }

    function resetUserState() {
      currentUser = null;
      tasks = [];
      // Preserve notes - reload from localStorage instead of clearing
      const savedNotes = localStorage.getItem('notes');
      if (savedNotes) {
        try {
          notes = JSON.parse(savedNotes);
        } catch (e) {
          console.error('Failed to parse saved notes', e);
          notes = [];
        }
      } else {
        notes = [];
      }
      pendingTaskSyncQueue = [];
      userStats = { xp: 0, level: 1, totalCompleted: 0, weeklyGoal: 10, weeklyCompleted: 0 };
      localStorage.removeItem('tasks');
      // Do NOT remove 'notes' from localStorage - preserve them across sign-out
      localStorage.removeItem('userStats');
      render();
      renderNotes();
      renderPinnedNotes();
      updateStatsDisplay();
    }

    function toggleAuthMode() {
      authMode = authMode === 'signin' ? 'signup' : 'signin';
      refreshAuthModeUI();
    }

    function openAuthModal(mode = 'signin') {
      authMode = mode;
      refreshAuthModeUI();
      const modal = document.getElementById('auth-modal');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeAuthModal() {
      const modal = document.getElementById('auth-modal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
      setAuthMessage('');
    }

    async function submitAuth() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value;
      const submitBtn = document.getElementById('auth-submit-btn');
      if (!email || !password) {
        setAuthMessage('Please fill in email and password', 'error');
        return;
      }
      setAuthMessage('');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = authMode === 'signup' ? 'Signing up...' : 'Signing in...';
      }
      try {
        if (authMode === 'signup') {
          const { error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          setAuthMessage('Account created! Check your email to confirm.', 'success');
          authMode = 'signin';
          toggleAuthMode();
        } else {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          currentUser = data.user;
          updateAuthUI();
          closeAuthModal();
          await syncFromSupabase();
        }
      } catch (err) {
        setAuthMessage(err.message || 'Auth error', 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = authMode === 'signup' ? 'Sign Up' : 'Sign In';
        }
      }
    }

    async function handleSignOut() {
      try {
        await signOutCurrentUser();
      } catch (err) {
        console.error('Sign out error:', err);
      }
    }

    function mapTaskFromSupabase(row) {
      return {
        id: row.id,
        title: row.title || 'Untitled',
        category: row.category || 'personal',
        status: row.status || 'todo',
        dueDate: row.due_date || '',
        importance: row.importance || 3,
        urgency: row.urgency || 3,
        notes: row.notes || '',
        tags: row.tags || [],
        subtasks: row.subtasks || [],
        pinned: row.pinned || false,
        createdAt: row.created_at || new Date().toISOString(),
        modifiedAt: row.modified_at || new Date().toISOString(),
        recurring: row.recurring || false,
        recurFrequency: row.recur_frequency || '',
        recurInterval: row.recur_interval || 1,
        recurDays: row.recur_days || [],
        dueTime: row.due_time || '',
        estimatedDuration: row.estimated_duration || 0
      };
    }

    function normalizeTask(task) {
      if (task.pinned === undefined) task.pinned = false;
      if (task.recurring === undefined) task.recurring = false;
      if (task.recurFrequency === undefined) task.recurFrequency = '';
      if (task.recurInterval === undefined) task.recurInterval = 1;
      if (task.recurDays === undefined) task.recurDays = [];
      if (task.tags === undefined) task.tags = [];
      if (task.subtasks === undefined) task.subtasks = [];
      if (task.notes === undefined) task.notes = '';
      if (task.dueTime === undefined) task.dueTime = '';
      if (task.estimatedDuration === undefined) task.estimatedDuration = 0;
      if (!task.status) task.status = 'todo';
      return task;
    }

    function taskToSupabaseRow(task, userId) {
      if (!userId) {
        console.error('taskToSupabaseRow called without userId', task);
        return null;
      }
      return {
        id: task.id,
        user_id: userId,
        title: task.title || 'Untitled',
        category: task.category || 'personal',
        status: task.status || 'todo',
        due_date: task.dueDate || null,
        importance: task.importance || 3,
        urgency: task.urgency || 3
      };
    }

    // Simplified sync for single task (matching supabase_minimal.html pattern)
    async function syncTaskToSupabase(task) {
      if (!currentUser) return;
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const userId = user?.id || currentUser.id;
        if (!userId) throw new Error('Missing user ID for task sync');

        // Provide default values consistent with taskToSupabaseRow()
        const payload = {
          id: task.id,
          user_id: userId,
          title: task.title || 'Untitled',
          category: task.category || 'personal',
          status: task.status || 'todo',
          due_date: task.dueDate || null,
          importance: task.importance || 3,
          urgency: task.urgency || 3
        };

        const { error } = await supabase
          .from('tasks')
          .upsert(payload);

        if (error) throw error;
      } catch (error) {
        console.error('Sync error:', error);
      }
    }

    // Batch sync for multiple tasks (used by saveTasks)
    async function syncTasksToSupabase(taskList = tasks) {
      if (!currentUser) return;
      const wasSyncing = isSyncing;
      try {
        const userId = currentUser.id;
        if (!userId) return;

        const rows = (taskList || []).map(task => taskToSupabaseRow(task, userId)).filter(row => row !== null);
        if (rows.length === 0) return;
        
        // Ensure all rows have user_id
        const rowsWithUserId = rows.map(row => ({
          ...row,
          user_id: row.user_id || userId
        }));
        
        const { error } = await supabase.from('tasks').upsert(rowsWithUserId);
        if (error) throw error;
        
        // Clear queue after successful sync
        pendingTaskSyncQueue = [];
        
        // Only update status if we're not already syncing (to avoid interrupting main sync)
        if (!wasSyncing) {
          updateSyncStatus('synced');
        }
      } catch (err) {
        console.error('Sync tasks error', err);
        // Update sync status to show error to user
        if (!wasSyncing) {
          updateSyncStatus('error', err.message || 'Failed to sync tasks');
        }
        // Re-throw so caller can handle if needed
        throw err;
      }
    }

    async function replaceSupabaseTasksWithLocal() {
      if (!currentUser) return;
      updateSyncStatus('syncing', 'Replacing cloud tasks...');
      try {
        const userId = await getCurrentUserId();
        if (!userId) throw new Error('Missing user ID for replace');
        await supabase.from('tasks').delete().eq('user_id', userId);
        await syncTasksToSupabase(tasks);
      } catch (err) {
        console.error('Replace tasks error', err);
        updateSyncStatus('error', err.message);
      }
    }

    async function deleteTaskFromSupabase(id) {
      if (!currentUser) return;
      try {
        await supabase
          .from('tasks')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);
        // Clear queue after successful delete
        pendingTaskSyncQueue = [];
      } catch (error) {
        console.error('Delete error:', error);
      }
    }

    async function syncStatsToSupabase() {
      if (!currentUser || !userStats.id) return;
      try {
        await supabase
          .from('user_stats')
          .update({
            xp: userStats.xp,
            level: userStats.level,
            total_completed: userStats.totalCompleted,
            weekly_goal: userStats.weeklyGoal,
            weekly_completed: userStats.weeklyCompleted
          })
          .eq('id', userStats.id)
          .eq('user_id', currentUser.id);
      } catch (error) {
        console.error('Stats sync error:', error);
      }
    }

    async function syncUserDataToSupabase() {
      if (!currentUser) return;
      try {
        const payload = {
          user_id: currentUser.id,
          data: { tasks, userStats }
        };
        await supabase.from('user_data').upsert(payload, { onConflict: 'user_id' });
      } catch (err) {
        if (err?.message && err.message.toLowerCase().includes('data')) {
          try {
            await supabase.from('user_data').upsert({ user_id: currentUser.id, payload: { tasks, userStats } }, { onConflict: 'user_id' });
          } catch (fallbackErr) {
            console.error('user_data sync error', fallbackErr);
          }
        } else {
          console.error('user_data sync error', err);
        }
      }
    }

    // restoreSession is now handled in init() - keeping for backward compatibility if called elsewhere
    async function restoreSession() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session && session.user) {
          currentUser = session.user;
          updateAuthUI();
          await syncFromSupabase();
        } else {
          currentUser = null;
          updateAuthUI();
          updateSyncStatus('synced');
        }
      } catch (err) {
        console.error('Session restore error', err);
        currentUser = null;
        updateAuthUI();
        updateSyncStatus('error', 'Unable to restore session');
      }
    }

    async function syncFromSupabase() {
      if (!currentUser) return;
      updateSyncStatus('syncing', 'Loading cloud data...');
      isSyncing = true;
      try {
        const userId = await getCurrentUserId();
        if (!userId) throw new Error('Missing user ID for fetch');

        if (navigator.onLine && pendingTaskSyncQueue.length) {
          try {
            await flushPendingTaskSync();
          } catch (err) {
            console.error('Queue flush error (non-fatal):', err);
          }
        }

        const { data: tasksData, error: tasksError } = await supabase
          .from('tasks')
          .select('*')
          .eq('user_id', userId);
        if (tasksError) throw tasksError;

        tasks = (tasksData || []).map(mapTaskFromSupabase).map(normalizeTask);
        render();

        const { data: statsData, error: statsError } = await supabase
          .from('user_stats')
          .select('*')
          .eq('user_id', userId)
          .maybeSingle();
        if (statsError && statsError.code !== 'PGRST116') throw statsError;

        if (statsData) {
          userStats = {
            id: statsData.id,
            xp: statsData.xp || 0,
            level: statsData.level || 1,
            totalCompleted: statsData.total_completed || 0,
            weeklyGoal: statsData.weekly_goal || 10,
            weeklyCompleted: statsData.weekly_completed || 0
          };
        } else {
          const { data: newStats, error: createError } = await supabase
            .from('user_stats')
            .insert([{
              user_id: userId,
              xp: 0,
              level: 1,
              total_completed: 0,
              weekly_goal: 10,
              weekly_completed: 0
            }])
            .select()
            .single();

          if (createError) throw createError;
          if (newStats) userStats.id = newStats.id;
        }

        // --- Notes: localStorage only, completely independent of Supabase ---
        const localNotesRaw = localStorage.getItem('notes');
        let effectiveNotes = [];
        try {
          if (localNotesRaw != null) {
            const parsed = JSON.parse(localNotesRaw);
            if (Array.isArray(parsed)) {
              effectiveNotes = parsed; // even [] is valid
            }
          }
        } catch (e) {
          // If parse fails, default to empty array
          console.error('Failed to parse saved notes', e);
          effectiveNotes = [];
        }

        // Assign to global notes array
        notes = effectiveNotes;

        saveTasks();
        saveStats();
        saveNotes();
        updateStatsDisplay();
        renderNotes();
        renderPinnedNotes();

        if (currentUser) {
          syncUserDataToSupabase().catch(console.error);
        }

        updateAuthUI();
        updateSyncStatus('synced');
      } catch (error) {
        console.error('Supabase sync error:', error);
        if (!tasks.length) {
          const saved = localStorage.getItem('tasks');
          if (saved) {
            try {
              tasks = JSON.parse(saved).map(normalizeTask);
              render();
            } catch (_) {}
          }
        } else {
          render();
        }
        updateSyncStatus('error', error.message || 'Failed to load tasks');
      } finally {
        isSyncing = false;
        if (pendingTaskSyncAfterCurrentSync && pendingTaskSyncQueue.length && navigator.onLine) {
          pendingTaskSyncAfterCurrentSync = false;
          flushPendingTaskSync().catch(console.error);
        }
        if (pendingNoteSync || pendingNoteSyncQueued) {
          pendingNoteSync = false;
          pendingNoteSyncQueued = false;
          syncUserDataToSupabase().catch(err => {
            console.error(err);
            pendingNoteSyncQueued = true;
            pendingNoteSync = true;
          });
        }
      }
    }

    function getQuad(imp, urg) {
      if (urg >= 4 && imp >= 4) return 'do-first';
      if (urg < 4 && imp >= 4) return 'schedule';
      if (urg >= 4 && imp < 4) return 'delegate';
      return 'eliminate';
    }

    function handleQuickAdd(event) {
      if (event.key === 'Enter') {
        const input = document.getElementById('quick-add-input');
        const text = input.value.trim();
        if (!text) return;
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tasks.push({
          id: Date.now(),
          title: text,
          category: 'personal',
          status: 'todo',
          dueDate: tomorrow.toISOString().split('T')[0],
          importance: 3,
          urgency: 3,
          notes: '',
          tags: [],
          subtasks: [],
          pinned: false,
          createdAt: new Date().toISOString(),
          recurring: false,
          recurFrequency: '',
          recurInterval: 1,
          recurDays: []
        });
        input.value = '';
        saveTasks();
        render();
        updateStatsDisplay();
      }
    }

    function toggleStatusDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('status-dropdown');
      dropdown.classList.toggle('show');
    }

    function toggleMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('main-menu');
      menu.classList.toggle('show');
    }

    function closeMenu() {
      document.getElementById('main-menu').classList.remove('show');
    }

    function toggleSearch() {
      const container = document.getElementById('search-container');
      container.classList.toggle('collapsed');
      container.classList.toggle('expanded');
    }

    function showAbout() {
      alert('TaskMatrix v2.1\n\nAn Eisenhower Matrix task management app.\n\nFeatures:\n‚Ä¢ 4-quadrant prioritization\n‚Ä¢ Drag & drop tasks\n‚Ä¢ Recurring tasks\n‚Ä¢ Quick notes with sticky cards\n‚Ä¢ Tags & subtasks\n‚Ä¢ Progress tracking\n‚Ä¢ Export/Import data');
    }

    function toggleStatsPopup() {
      const popup = document.getElementById('stats-popup');
      if (popup.classList.contains('show')) {
        closeStatsPopup();
      } else {
        popup.classList.add('show');
        updateStatsDisplay();
      }
    }

    function closeStatsPopup() {
      document.getElementById('stats-popup').classList.remove('show');
    }

    function openNotesModal() {
      document.getElementById('notes-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
      noteCategoryFilter = 'all';
      updateFilterTabs();
      renderNotes();
    }

    function closeNotesModal() {
      document.getElementById('notes-modal').classList.remove('active');
      document.body.style.overflow = 'auto';
      document.getElementById('notes-search').value = '';
    }

    function closeNotesModalOnOverlay(event) {
      if (event.target.id === 'notes-modal') closeNotesModal();
    }

    function renderNotes(searchTerm = '') {
      const grid = document.getElementById('notes-grid');
      let filteredNotes = notes;

      // Filter by category
      if (noteCategoryFilter !== 'all') {
        filteredNotes = filteredNotes.filter(n => n.category === noteCategoryFilter);
      }

      // Filter by search term
      if (searchTerm) {
        filteredNotes = filteredNotes.filter(n =>
          n.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
          n.content.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }

      if (filteredNotes.length === 0 && searchTerm === '' && noteCategoryFilter === 'all') {
        grid.innerHTML = `
          <div class="empty-notes">
            <div class="empty-notes-icon">üìù</div>
            <div class="empty-notes-text">No notes yet</div>
            <div class="empty-notes-subtext">Click "+ New Note" to create your first note</div>
          </div>
        `;
        return;
      }

      if (filteredNotes.length === 0) {
        grid.innerHTML = `
          <div class="empty-notes">
            <div class="empty-notes-icon">üîç</div>
            <div class="empty-notes-text">No notes found</div>
            <div class="empty-notes-subtext">Try a different filter or search term</div>
          </div>
        `;
        return;
      }

      const categoryEmojis = {
        'ideas': 'üí°',
        'tasks': '‚úÖ',
        'reference': 'üìö',
        'notes': 'üìù',
        'quick': '‚ö°'
      };

      grid.innerHTML = filteredNotes.map(note => {
        const rendered = renderNoteContent(note.content);
        const preview = rendered.length > 100 ? rendered.substring(0, 100) + '...' : rendered;
        const timeAgo = getTimeAgo(note.modifiedAt);
        const categoryEmoji = categoryEmojis[note.category || 'notes'];
        return `
          <div class="note-card ${note.color}" style="position: relative;">
            <button class="note-delete-btn" onclick="event.stopPropagation(); deleteNoteFromCard(${note.id})" title="Delete note">√ó</button>
            <div class="note-category-badge">${categoryEmoji}</div>
            <div onclick="editNote(${note.id})">
              <div class="note-card-header">${note.title || 'Untitled'}</div>
              <div class="note-card-content">${preview || 'Empty note'}</div>
              <div class="note-card-footer">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function deleteNoteFromCard(noteId) {
      if (confirm('Delete this note?')) {
        notes = notes.filter(n => n.id !== noteId);
        saveNotesAndSync();
        renderNotes();
        renderPinnedNotes();
      }
    }

    function filterNotesByCategory(category) {
      noteCategoryFilter = category;
      updateFilterTabs();
      renderNotes();
    }

    function updateFilterTabs() {
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.category === noteCategoryFilter) {
          tab.classList.add('active');
        }
      });
    }

    function renderNoteContent(content) {
      if (!content) return '';
      // Simple text representation for preview
      return content
        .replace(/-?\s*\[\s\]/g, '‚òê')
        .replace(/-?\s*\[x\]/gi, '‚òë')
        .replace(/^- /gm, '‚Ä¢ ')
        .replace(/^#+\s+(.+)$/gm, '$1')
        .replace(/\*\*(.+?)\*\*/g, '$1')
        .replace(/__(.+?)__/g, '$1')
        .replace(/~~(.+?)~~/g, '$1')
        .replace(/\*(.+?)\*/g, '$1');
    }

    function formatInlineNoteText(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<span style="text-decoration: underline;">$1</span>')
        .replace(/~~(.*?)~~/g, '<del>$1</del>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }

    function parseNoteToHTML(content) {
      if (!content) return '<p style="color: var(--text-muted);">Empty note</p>';
      
      const lines = content.split('\n');
      let html = '';
      let inList = false;
      let listType = '';
      
      lines.forEach(line => {
        const trimmed = line.trim();
        const uncheckedMatch = trimmed.match(/^-?\s*\[\s\]\s?(.*)/);
        const checkedMatch = trimmed.match(/^-?\s*\[x\]\s?(.*)/i);
        
        // Headings
        if (trimmed.startsWith('# ')) {
          if (inList) { html += `</${listType}>`;  inList = false; }
          html += `<h3 style="font-size: 18px; font-weight: bold; margin: 12px 0 8px 0;">${trimmed.substring(2)}</h3>`;
        }
        else if (trimmed.startsWith('## ')) {
          if (inList) { html += `</${listType}>`;  inList = false; }
          html += `<h4 style="font-size: 16px; font-weight: bold; margin: 10px 0 6px 0;">${trimmed.substring(3)}</h4>`;
        }
        // Checkboxes - unchecked
        else if (uncheckedMatch) {
          if (!inList || listType !== 'ul-check') {
            if (inList) html += `</${listType}>`;
            html += '<ul style="list-style: none; padding-left: 0;">';
            inList = true;
            listType = 'ul-check';
          }
          const text = formatInlineNoteText(uncheckedMatch[1].trim());
          html += `<li style="margin-bottom: 6px;"><input type="checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;" disabled> <span>${text}</span></li>`;
        }
        // Checkboxes - checked
        else if (checkedMatch) {
          if (!inList || listType !== 'ul-check') {
            if (inList) html += `</${listType}>`;
            html += '<ul style="list-style: none; padding-left: 0;">';
            inList = true;
            listType = 'ul-check';
          }
          const text = formatInlineNoteText(checkedMatch[1].trim());
          html += `<li style="margin-bottom: 6px;"><input type="checkbox" checked style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;" disabled> <span class="checked-item">${text}</span></li>`;
        }
        // Bullets
        else if (trimmed.startsWith('- ')) {
          if (!inList || listType !== 'ul') {
            if (inList) html += `</${listType}>`;
            html += '<ul style="margin-left: 20px;">';
            inList = true;
            listType = 'ul';
          }
          html += `<li>${formatInlineNoteText(trimmed.substring(2))}</li>`;
        }
        // Numbered
        else if (trimmed.match(/^\d+\.\s/)) {
          if (!inList || listType !== 'ol') {
            if (inList) html += `</${listType}>`;
            html += '<ol style="margin-left: 20px;">';
            inList = true;
            listType = 'ol';
          }
          html += `<li>${formatInlineNoteText(trimmed.replace(/^\d+\.\s/, ''))}</li>`;
        }
        // Bold
        else if (trimmed.includes('**')) {
          if (inList) { html += `</${listType}>`;  inList = false; }
          const formatted = formatInlineNoteText(trimmed);
          html += `<p>${formatted}</p>`;
        }
        // Italic
        else if (trimmed.includes('*')) {
          if (inList) { html += `</${listType}>`;  inList = false; }
          const formatted = formatInlineNoteText(trimmed);
          html += `<p>${formatted}</p>`;
        }
        // Regular text
        else if (trimmed) {
          if (inList) { html += `</${listType}>`;  inList = false; }
          html += `<p>${formatInlineNoteText(trimmed)}</p>`;
        }
        // Empty line
        else {
          if (inList) { html += `</${listType}>`;  inList = false; }
          html += '<br>';
        }
      });
      
      if (inList) html += `</${listType}>`;
      
      return html || '<p style="color: var(--text-muted);">Empty note</p>';
    }

    function renderPinnedNotes() {
      const container = document.getElementById('pinned-notes-section');
      const grid = document.getElementById('pinned-notes-grid');
      const pinnedNotes = notes.filter(n => n.pinned);

      if (pinnedNotes.length === 0) {
        container.classList.remove('has-notes');
        return;
      }

      const categoryEmojis = {
        'ideas': 'üí°',
        'tasks': '‚úÖ',
        'reference': 'üìö',
        'notes': 'üìù',
        'quick': '‚ö°'
      };

      container.classList.add('has-notes');
      grid.innerHTML = pinnedNotes.map(note => {
        const preview = note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content;
        const categoryEmoji = categoryEmojis[note.category || 'notes'];
        return `
          <div class="note-card ${note.color}" style="position: relative;">
            <button class="note-delete-btn" onclick="event.stopPropagation(); deleteNoteFromCard(${note.id})" title="Delete note">√ó</button>
            <div onclick="editNote(${note.id})">
              <div class="note-card-header">
                <span>${note.title || 'Untitled'}</span>
                <span style="font-size: 12px;">üìå ${categoryEmoji}</span>
              </div>
              <div class="note-card-content">${preview || 'Empty note'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterNotes() {
      const searchTerm = document.getElementById('notes-search').value;
      renderNotes(searchTerm);
    }

    function createNewNote() {
      currentEditingNote = null;
      currentNoteColor = 'yellow';
      currentNoteCategory = 'notes';
      noteViewMode = 'edit';
      document.getElementById('note-title-input').value = '';
      document.getElementById('note-content-input').value = '';
      document.getElementById('note-pinned-input').checked = false;
      document.getElementById('note-created-date').textContent = new Date().toLocaleString();
      document.getElementById('note-edited-date').textContent = '-';

      document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
      document.querySelector('.color-option.yellow').classList.add('selected');

      // Hide delete button for new notes
      const deleteBtn = document.getElementById('delete-note-btn');
      if (deleteBtn) deleteBtn.style.display = 'none';

      updateCategorySelection();
      switchNoteView('edit');
      document.getElementById('note-edit-modal').classList.add('active');
      setTimeout(setupNoteToolbar, 50);
    }

    function editNote(noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;

      currentEditingNote = note;
      currentNoteColor = note.color;
      currentNoteCategory = note.category || 'notes';
      noteViewMode = 'edit';
      document.getElementById('note-title-input').value = note.title;
      document.getElementById('note-content-input').value = note.content;
      document.getElementById('note-pinned-input').checked = note.pinned || false;
      document.getElementById('note-created-date').textContent = new Date(note.createdAt).toLocaleString();
      document.getElementById('note-edited-date').textContent = new Date(note.modifiedAt).toLocaleString();
      
      // Show delete button for existing notes
      const deleteBtn = document.getElementById('delete-note-btn');
      if (deleteBtn) deleteBtn.style.display = 'block';

      updateColorSelection();
      updateCategorySelection();
      switchNoteView('edit');
      document.getElementById('note-edit-modal').classList.add('active');
      setTimeout(setupNoteToolbar, 50);
    }

    function selectNoteCategory(category) {
      currentNoteCategory = category;
      updateCategorySelection();
    }

    function updateCategorySelection() {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.category === currentNoteCategory) {
          btn.classList.add('selected');
        }
      });
    }

    function setupNoteToolbar() {
      const editViewBtn = document.getElementById('edit-view-btn');
      const previewViewBtn = document.getElementById('preview-view-btn');
      const noteToolbar = document.querySelector('.note-toolbar');

      // Category buttons
      const catIdeas = document.getElementById('cat-ideas');
      const catTasks = document.getElementById('cat-tasks');
      const catReference = document.getElementById('cat-reference');
      const catNotes = document.getElementById('cat-notes');
      const catQuick = document.getElementById('cat-quick');

      if (editViewBtn) editViewBtn.onclick = () => switchNoteView('edit');
      if (previewViewBtn) previewViewBtn.onclick = () => switchNoteView('preview');
      if (noteToolbar) noteToolbar.onclick = handleNoteToolbarClick;

      if (catIdeas) catIdeas.onclick = () => selectNoteCategory('ideas');
      if (catTasks) catTasks.onclick = () => selectNoteCategory('tasks');
      if (catReference) catReference.onclick = () => selectNoteCategory('reference');
      if (catNotes) catNotes.onclick = () => selectNoteCategory('notes');
      if (catQuick) catQuick.onclick = () => selectNoteCategory('quick');
    }

    function handleNoteToolbarClick(event) {
      const toolbar = event.currentTarget;
      const button = event.target.closest('.toolbar-btn');
      if (!button || !toolbar.contains(button)) return;

      const actionKey = (button.dataset.format || button.id || '').replace('-btn', '');
      const actions = {
        bullet: insertBullet,
        checkbox: insertCheckbox,
        numbered: insertNumbered,
        heading: insertHeading,
        bold: insertBold,
        italic: insertItalic,
        underline: insertUnderline,
        strikethrough: insertStrikethrough
      };

      const action = actions[actionKey];
      if (action) action();
    }

    function switchNoteView(mode) {
      noteViewMode = mode;
      const editArea = document.getElementById('note-edit-area');
      const previewArea = document.getElementById('note-preview-area');
      const editBtn = document.getElementById('edit-view-btn');
      const previewBtn = document.getElementById('preview-view-btn');

      if (mode === 'edit') {
        editArea.style.display = 'block';
        previewArea.style.display = 'none';
        editBtn.classList.add('active');
        previewBtn.classList.remove('active');
      } else {
        editArea.style.display = 'none';
        previewArea.style.display = 'block';
        editBtn.classList.remove('active');
        previewBtn.classList.add('active');
        
        // Update preview
        const content = document.getElementById('note-content-input').value;
        document.getElementById('note-preview-content').innerHTML = parseNoteToHTML(content);
      }
    }

    function applyNoteTextUpdate(textarea, newValue, selectionStart, selectionEnd) {
      if (!textarea) return;
      textarea.value = newValue;
      textarea.selectionStart = selectionStart;
      textarea.selectionEnd = selectionEnd;
      textarea.focus();
      textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function insertBullet() {
      insertTextAtCursor('- ');
    }

    function insertCheckbox() {
      const textarea = document.getElementById('note-content-input');
      if (!textarea) return;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const currentValue = textarea.value;
      const selectedText = currentValue.substring(start, end);
      
      const lineStart = currentValue.lastIndexOf('\n', start - 1) + 1;
      const needsNewLine = lineStart !== start;
      const prefix = needsNewLine ? '\n' : '';
      const insertion = `${prefix}- [ ] ${selectedText}`;
      const newValue = currentValue.substring(0, start) + insertion + currentValue.substring(end);
      const selectionStart = start + prefix.length + 6; // position after "- [ ] "
      const selectionEnd = selectionStart + selectedText.length;

      applyNoteTextUpdate(textarea, newValue, selectionStart, selectionEnd);
    }

    function insertNumbered() {
      const textarea = document.getElementById('note-content-input');
      if (!textarea) return;
      const start = textarea.selectionStart;
      const currentValue = textarea.value;
      
      // Find the start of the current line
      const beforeCursor = currentValue.substring(0, start);
      const lineStart = beforeCursor.lastIndexOf('\n') + 1;
      const currentLine = beforeCursor.substring(lineStart);
      
      // Check if previous line has a number
      const lines = beforeCursor.split('\n');
      let nextNumber = 1;
      
      // Look for the last numbered item
      for (let i = lines.length - 1; i >= 0; i--) {
        const match = lines[i].match(/^(\d+)\.\s/);
        if (match) {
          nextNumber = parseInt(match[1]) + 1;
          break;
        }
      }
      
      insertTextAtCursor(`${nextNumber}. `);
    }

    function handleNoteKeydown(event) {
      if (event.key === 'Enter') {
        const textarea = event.target;
        const start = textarea.selectionStart;
        const currentValue = textarea.value;
        
        // Find the start of the current line
        const beforeCursor = currentValue.substring(0, start);
        const lineStart = beforeCursor.lastIndexOf('\n') + 1;
        const currentLine = beforeCursor.substring(lineStart);
        
        // Check if current line is a numbered list item
        const numberedMatch = currentLine.match(/^(\d+)\.\s/);
        if (numberedMatch) {
          event.preventDefault();
          const currentNumber = parseInt(numberedMatch[1]);
          const nextNumber = currentNumber + 1;
          
          // Check if line is empty (just the number)
          if (currentLine.trim() === `${currentNumber}.`) {
            // Remove the empty numbered item
            textarea.value = currentValue.substring(0, lineStart) + currentValue.substring(start);
            textarea.selectionStart = textarea.selectionEnd = lineStart;
          } else {
            // Insert new numbered item
            const insertion = `\n${nextNumber}. `;
            textarea.value = currentValue.substring(0, start) + insertion + currentValue.substring(start);
            textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
          }
          return;
        }
        
        // Check if current line is a bullet list item
        const bulletMatch = currentLine.match(/^-\s/);
        if (bulletMatch) {
          event.preventDefault();
          
          // Check if line is empty (just the bullet)
          if (currentLine.trim() === '-') {
            // Remove the empty bullet
            textarea.value = currentValue.substring(0, lineStart) + currentValue.substring(start);
            textarea.selectionStart = textarea.selectionEnd = lineStart;
          } else {
            // Insert new bullet
            const insertion = `\n- `;
            textarea.value = currentValue.substring(0, start) + insertion + currentValue.substring(start);
            textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
          }
          return;
        }
        
        // Check if current line is a checkbox item
        const checkboxMatch = currentLine.match(/^-?\s*\[\s?\]\s/);
        if (checkboxMatch) {
          event.preventDefault();
          const trimmedLine = currentLine.trim();
          
          // Check if line is empty (just the checkbox)
          if (trimmedLine === '- [ ]' || trimmedLine === '[ ]' || trimmedLine === '[]') {
            // Remove the empty checkbox
            textarea.value = currentValue.substring(0, lineStart) + currentValue.substring(start);
            textarea.selectionStart = textarea.selectionEnd = lineStart;
          } else {
            // Insert new checkbox
            const insertion = `\n- [ ] `;
            textarea.value = currentValue.substring(0, start) + insertion + currentValue.substring(start);
            textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
          }
          return;
        }
      }
    }

    function insertHeading() {
      insertTextAtCursor('# ');
    }

    function insertBold() {
      applyWrappedFormat('bold');
    }

    function insertItalic() {
      applyWrappedFormat('italic');
    }

    function insertUnderline() {
      applyWrappedFormat('underline');
    }

    function insertStrikethrough() {
      applyWrappedFormat('strikethrough');
    }

    function insertTextAtCursor(text) {
      const textarea = document.getElementById('note-content-input');
      if (!textarea) return;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const currentValue = textarea.value;
      
      // Insert text at cursor position
      const newValue = currentValue.substring(0, start) + text + currentValue.substring(end);
      const newPosition = start + text.length;

      applyNoteTextUpdate(textarea, newValue, newPosition, newPosition);
    }

    function applyWrappedFormat(format) {
      const textarea = document.getElementById('note-content-input');
      if (!textarea) return;

      const markers = {
        bold: { marker: '**', placeholder: 'strong' },
        italic: { marker: '*', placeholder: 'em' },
        underline: { marker: '__', placeholder: 'underline' },
        strikethrough: { marker: '~~', placeholder: 'strike' }
      };

      const config = markers[format];
      if (!config) return;

      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const currentValue = textarea.value;
      const selectedText = currentValue.substring(start, end);
      const textToWrap = selectedText || config.placeholder;
      const wrappedText = `${config.marker}${textToWrap}${config.marker}`;
      const newValue = currentValue.substring(0, start) + wrappedText + currentValue.substring(end);

      const selectionStart = start + config.marker.length;
      const selectionEnd = selectionStart + textToWrap.length;

      applyNoteTextUpdate(textarea, newValue, selectionStart, selectionEnd);
    }

    function closeNoteEditModal() {
      document.getElementById('note-edit-modal').classList.remove('active');
      currentEditingNote = null;
    }

    function closeNoteEditModalOnOverlay(event) {
      if (event.target.id === 'note-edit-modal') closeNoteEditModal();
    }

    function selectNoteColor(color) {
      currentNoteColor = color;
      updateColorSelection();
    }

    function updateColorSelection() {
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.querySelector(`.color-option.${currentNoteColor}`).classList.add('selected');
    }

    function saveCurrentNote() {
      const title = document.getElementById('note-title-input').value.trim();
      const content = document.getElementById('note-content-input').value.trim();
      const pinned = document.getElementById('note-pinned-input').checked;

      if (!title && !content) {
        alert('Please add a title or content to your note');
        return;
      }

      if (currentEditingNote) {
        currentEditingNote.title = title;
        currentEditingNote.content = content;
        currentEditingNote.color = currentNoteColor;
        currentEditingNote.category = currentNoteCategory;
        currentEditingNote.pinned = pinned;
        currentEditingNote.modifiedAt = new Date().toISOString();
      } else {
        const newNote = {
          id: Date.now(),
          title: title || 'Untitled',
          content: content,
          color: currentNoteColor,
          category: currentNoteCategory,
          pinned: pinned,
          createdAt: new Date().toISOString(),
          modifiedAt: new Date().toISOString()
        };
        notes.unshift(newNote);
      }

      saveNotesAndSync();
      renderNotes();
      renderPinnedNotes();
      closeNoteEditModal();
    }

    function deleteCurrentNote() {
      if (!currentEditingNote) return;
      if (confirm('Delete this note?')) {
        notes = notes.filter(n => n.id !== currentEditingNote.id);
        saveNotesAndSync();
        renderNotes();
        renderPinnedNotes();
        closeNoteEditModal();
      }
    }

    function convertNoteToTask() {
      const title = document.getElementById('note-title-input').value.trim();
      const content = document.getElementById('note-content-input').value.trim();

      if (!title && !content) {
        alert('Note is empty');
        return;
      }

      const taskTitle = title || content.split('\n')[0].substring(0, 100);
      const taskNotes = content;

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);

      tasks.push({
        id: Date.now(),
        title: taskTitle,
        category: 'personal',
        status: 'todo',
        dueDate: tomorrow.toISOString().split('T')[0],
        importance: 3,
        urgency: 3,
        notes: taskNotes,
        tags: [],
        subtasks: [],
        pinned: false,
        createdAt: new Date().toISOString(),
        recurring: false,
        recurFrequency: '',
        recurInterval: 1,
        recurDays: []
      });

      saveTasks();
      render();
      updateStatsDisplay();

      if (confirm('Note converted to task! Delete the original note?')) {
        deleteCurrentNote();
      } else {
        closeNoteEditModal();
      }

      alert('‚úÖ Task created successfully!');
    }

    function getTimeAgo(dateString) {
      const now = new Date();
      const past = new Date(dateString);
      const diffMs = now - past;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return past.toLocaleDateString();
    }

    document.addEventListener('click', function (event) {
      if (!event.target.closest('.menu-dropdown')) {
        closeMenu();
      }
      if (!event.target.closest('.sort-dropdown')) {
        document.querySelectorAll('.sort-dropdown-menu').forEach(menu => menu.classList.remove('show'));
      }
      if (!event.target.closest('.status-indicator') && !event.target.closest('.status-dropdown')) {
        document.getElementById('status-dropdown').classList.remove('show');
      }
      if (!event.target.closest('.stats-popup') && !event.target.closest('.floating-badge.stats')) {
        closeStatsPopup();
      }
    });

    function toggleTaskStatus(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      if (task.status === 'todo') task.status = 'in-progress';
      else if (task.status === 'in-progress') {
        task.status = 'completed';
        awardXP(task);
        if (task.recurring) {
          createNextRecurrence(task);
        }
      }
      else task.status = 'todo';
      saveTasks();
      render();
      updateStatsDisplay();
      if (showCompleted) renderCompletedTasks();
    }

    function createNextRecurrence(completedTask) {
      if (!completedTask.dueDate) return;

      const currentDue = new Date(completedTask.dueDate);
      let nextDue = new Date(currentDue);

      if (completedTask.recurFrequency === 'daily') {
        nextDue.setDate(nextDue.getDate() + 1);
      } else if (completedTask.recurFrequency === 'weekly') {
        if (completedTask.recurDays && completedTask.recurDays.length > 0) {
          const today = currentDue.getDay();
          const sortedDays = completedTask.recurDays.sort((a, b) => a - b);
          let nextDay = sortedDays.find(d => d > today);
          if (!nextDay) nextDay = sortedDays[0];
          const daysToAdd = nextDay > today ? nextDay - today : 7 - today + nextDay;
          nextDue.setDate(nextDue.getDate() + daysToAdd);
        } else {
          nextDue.setDate(nextDue.getDate() + 7);
        }
      } else if (completedTask.recurFrequency === 'monthly') {
        nextDue.setMonth(nextDue.getMonth() + 1);
      } else if (completedTask.recurFrequency === 'custom' && completedTask.recurInterval) {
        nextDue.setDate(nextDue.getDate() + completedTask.recurInterval);
      }

      const newTask = {
        id: Date.now(),
        title: completedTask.title,
        category: completedTask.category,
        status: 'todo',
        dueDate: nextDue.toISOString().split('T')[0],
        dueTime: completedTask.dueTime || '',
        importance: completedTask.importance,
        urgency: completedTask.urgency,
        notes: completedTask.notes,
        tags: [...(completedTask.tags || [])],
        subtasks: (completedTask.subtasks || []).map(st => ({ ...st, completed: false })),
        estimatedDuration: completedTask.estimatedDuration,
        pinned: false,
        createdAt: new Date().toISOString(),
        modifiedAt: new Date().toISOString(),
        recurring: true,
        recurFrequency: completedTask.recurFrequency,
        recurInterval: completedTask.recurInterval,
        recurDays: [...(completedTask.recurDays || [])]
      };

      tasks.push(newTask);
      saveTasks();
    }

    function awardXP(task) {
      const quad = getQuad(task.importance, task.urgency);
      let xp = 10;
      if (quad === 'do-first') xp = 50;
      else if (quad === 'schedule') xp = 40;
      else if (quad === 'delegate') xp = 20;
      userStats.xp += xp;
      userStats.level = Math.floor(userStats.xp / 100) + 1;
      userStats.totalCompleted++;
      userStats.weeklyCompleted++;
      saveStats();
    }

    function deleteTask(id) {
      if (confirm('Delete this task?')) {
        tasks = tasks.filter(t => t.id !== id);
        if (currentUser) deleteTaskFromSupabase(id);
        saveTasks();
        render();
        updateStatsDisplay();
        if (showCompleted) renderCompletedTasks();
      }
    }

    function toggleCompletedSection() {
      showCompleted = !showCompleted;
      const section = document.getElementById('completed-section');
      const menuText = document.getElementById('menu-completed-text');
      if (showCompleted) {
        section.classList.add('show');
        menuText.textContent = 'Hide Completed';
        renderCompletedTasks();
      } else {
        section.classList.remove('show');
        menuText.textContent = 'Show Completed';
      }
    }

    function renderCompletedTasks() {
      const completedTasks = tasks.filter(t => t.status === 'completed');
      const container = document.getElementById('completed-tasks-list');
      if (completedTasks.length === 0) {
        container.innerHTML = '<div class="empty-state">No completed tasks yet</div>';
        return;
      }
      container.innerHTML = completedTasks.map(t =>
        `<div class="task ${t.category}" style="opacity:0.8;"><div class="task-content"><button class="icon-btn" onclick="toggleTaskStatus(${t.id})">‚úì</button><div class="task-info"><div class="task-title completed">${t.title}</div></div><button class="icon-btn" onclick="deleteTask(${t.id})">√ó</button></div></div>`
      ).join('');
    }

    function clearCompleted() {
      const completedTasks = tasks.filter(t => t.status === 'completed');
      if (completedTasks.length === 0) return alert('No completed tasks');
      if (confirm(`Delete all ${completedTasks.length} completed tasks?`)) {
        if (currentUser) completedTasks.forEach(t => deleteTaskFromSupabase(t.id));
        tasks = tasks.filter(t => t.status !== 'completed');
        saveTasks();
        renderCompletedTasks();
        render();
        updateStatsDisplay();
      }
    }

    function exportData() {
      const data = JSON.stringify({ tasks, userStats, notes }, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `taskmatrix-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.tasks || !Array.isArray(data.tasks)) return alert('Invalid file');
          if (confirm('Import backup? This will replace current data.')) {
            tasks = data.tasks;
            userStats = data.userStats || userStats;
            notes = data.notes || [];
            saveTasks();
            saveStats();
            saveNotes();
            render();
            updateStatsDisplay();
            if (currentUser) {
              await replaceSupabaseTasksWithLocal();
              await syncStatsToSupabase();
              await syncUserDataToSupabase();
            }
            alert('‚úÖ Import successful!');
          }
        } catch (error) {
          alert('‚ùå Import failed: ' + error.message);
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function drag(e, task) {
      draggedTask = task;
      e.dataTransfer.effectAllowed = 'move';
    }

    function dragEnd() { draggedTask = null; }
    function allowDrop(e) { e.preventDefault(); }

    function drop(e, quad) {
      e.preventDefault();
      if (!draggedTask) return;
      let imp = 3, urg = 3;
      if (quad === 'do-first') { imp = 5; urg = 5; }
      else if (quad === 'schedule') { imp = 5; urg = 2; }
      else if (quad === 'delegate') { imp = 2; urg = 5; }
      else if (quad === 'eliminate') { imp = 2; urg = 2; }
      const task = tasks.find(t => t.id === draggedTask.id);
      if (task) { task.importance = imp; task.urgency = urg; }
      draggedTask = null;
      saveTasks();
      render();
    }

    function getDueStatus(dueDate) {
      if (!dueDate) return '';
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const due = new Date(dueDate); due.setHours(0, 0, 0, 0);
      const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      if (diffDays < 0) return 'overdue';
      if (diffDays === 0) return 'today';
      if (diffDays <= 7) return 'soon';
      return '';
    }

    function isThisWeek(dateStr) {
      if (!dateStr) return false;
      const date = new Date(dateStr);
      const today = new Date();
      const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      return date >= today && date <= weekFromNow;
    }

    function sortTasks(taskList, mode) {
      let sorted = taskList.slice();
      sorted.sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return 0;
      });
      if (mode === 'date') {
        sorted.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          if (!a.dueDate && !b.dueDate) return 0;
          if (!a.dueDate) return 1;
          if (!b.dueDate) return -1;
          return new Date(a.dueDate) - new Date(b.dueDate);
        });
      } else if (mode === 'alpha') {
        sorted.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
        });
      }
      return sorted;
    }

    function applyFilters() {
      filters.search = document.getElementById('search-input').value;
      filters.category = document.getElementById('filter-category').value;
      filters.status = document.getElementById('filter-status').value;
      filters.date = document.getElementById('filter-date').value;
      render();
    }

    function clearFilters() {
      filters = { search: '', category: 'all', status: 'all', date: 'all' };
      document.getElementById('search-input').value = '';
      document.getElementById('filter-category').value = 'all';
      document.getElementById('filter-status').value = 'all';
      document.getElementById('filter-date').value = 'all';
      render();
    }

    function togglePin(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.pinned = !task.pinned;
      saveTasks();
      render();
    }

    function toggleSortDropdown(quad, event) {
      event.stopPropagation();
      const menu = document.getElementById('sort-menu-' + quad);
      const allMenus = document.querySelectorAll('.sort-dropdown-menu');
      allMenus.forEach(m => { if (m.id !== 'sort-menu-' + quad) m.classList.remove('show'); });
      menu.classList.toggle('show');
    }

    function setSortMode(quad, mode, event) {
      event.stopPropagation();
      sortModes[quad] = mode;
      const menu = document.getElementById('sort-menu-' + quad);
      const items = menu.querySelectorAll('.sort-dropdown-item');
      items.forEach(item => {
        item.classList.remove('active');
        if (item.onclick.toString().includes("'" + mode + "'")) item.classList.add('active');
      });
      menu.classList.remove('show');
      render();
    }

    function updateStatsDisplay() {
      const activeTasks = tasks.filter(t => t.status !== 'completed');
      const quadrants = {
        'do-first': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'do-first'),
        'schedule': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'schedule'),
        'delegate': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'delegate'),
        'eliminate': activeTasks.filter(t => getQuad(t.importance, t.urgency) === 'eliminate')
      };

      document.getElementById('popup-level').textContent = userStats.level;
      document.getElementById('popup-xp').textContent = userStats.xp % 100;
      document.getElementById('popup-weekly').textContent = userStats.weeklyCompleted + '/' + userStats.weeklyGoal;
      document.getElementById('popup-completed').textContent = userStats.totalCompleted;

      const xpPercent = (userStats.xp % 100);
      document.getElementById('popup-xp-fill').style.width = xpPercent + '%';

      const weeklyPercent = Math.min(100, (userStats.weeklyCompleted / userStats.weeklyGoal) * 100);
      document.getElementById('popup-weekly-fill').style.width = weeklyPercent + '%';

      document.getElementById('popup-stat-first').textContent = quadrants['do-first'].length;
      document.getElementById('popup-stat-schedule').textContent = quadrants['schedule'].length;
      document.getElementById('popup-stat-delegate').textContent = quadrants['delegate'].length;
      document.getElementById('popup-stat-eliminate').textContent = quadrants['eliminate'].length;
    }

    function render() {
      if (!document.getElementById('tasks-do-first')) return;

      const activeTasks = tasks.filter(t => t.status !== 'completed');
      const filteredTasks = activeTasks.filter(task => {
        if (filters.search && !task.title.toLowerCase().includes(filters.search.toLowerCase())) return false;
        if (filters.category !== 'all' && task.category !== filters.category) return false;
        if (filters.status !== 'all' && task.status !== filters.status) return false;
        if (filters.date !== 'all') {
          const dueStatus = getDueStatus(task.dueDate);
          if (filters.date === 'overdue' && dueStatus !== 'overdue') return false;
          if (filters.date === 'today' && dueStatus !== 'today') return false;
          if (filters.date === 'week' && !isThisWeek(task.dueDate)) return false;
        }
        return true;
      });

      const quadrants = {
        'do-first': filteredTasks.filter(t => getQuad(t.importance, t.urgency) === 'do-first'),
        'schedule': filteredTasks.filter(t => getQuad(t.importance, t.urgency) === 'schedule'),
        'delegate': filteredTasks.filter(t => getQuad(t.importance, t.urgency) === 'delegate'),
        'eliminate': filteredTasks.filter(t => getQuad(t.importance, t.urgency) === 'eliminate')
      };

      ['do-first', 'schedule', 'delegate', 'eliminate'].forEach(quad => {
        const container = document.getElementById('tasks-' + quad);
        const countId = quad === 'do-first' ? 'count-first' : 'count-' + quad;
        const count = document.getElementById(countId);
        if (!container || !count) return;

        const sortedTasks = sortTasks(quadrants[quad], sortModes[quad]);
        count.textContent = sortedTasks.length;

        if (sortedTasks.length === 0) {
          container.innerHTML = '<div class="empty-state">Drag tasks here</div>';
        } else {
          container.innerHTML = sortedTasks.map(task => {
            const statusIcon = task.status === 'completed' ? '‚úì' : task.status === 'in-progress' ? '‚è±' : '‚óã';
            const statusColor = task.status === 'completed' ? '#16a34a' : task.status === 'in-progress' ? '#3b82f6' : '#9ca3af';
            const dueStatus = getDueStatus(task.dueDate);
            let dueClass = '';
            let dueBadge = '';
            if (dueStatus === 'overdue') { dueClass = 'overdue'; dueBadge = '<span class="due-badge overdue">Overdue</span>'; }
            else if (dueStatus === 'today') { dueClass = 'due-today'; dueBadge = '<span class="due-badge today">Today</span>'; }
            else if (dueStatus === 'soon') { dueClass = 'due-soon'; dueBadge = '<span class="due-badge soon">This Week</span>'; }
            const pinnedClass = task.pinned ? 'pinned' : '';
            const pinIcon = task.pinned ? 'üìå' : 'üìç';
            const recurBadge = task.recurring ? '<span class="recurring-badge">üîÑ</span>' : '';
            const taskJson = JSON.stringify(task).replace(/"/g, '&quot;');
            return `<div class="task ${task.category} ${dueClass} ${pinnedClass}" draggable="true" ondragstart="drag(event, ${taskJson})" ondragend="dragEnd()">
              <div class="task-content">
                <button class="icon-btn" onclick="event.stopPropagation(); toggleTaskStatus(${task.id})" style="color:${statusColor}; font-size:20px;">${statusIcon}</button>
                <div class="task-info" onclick="openTaskModal(${task.id})"><div class="task-title ${task.status === 'completed' ? 'completed' : ''}">${task.title}${dueBadge}${recurBadge}</div></div>
                <button class="pin-btn ${task.pinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin(${task.id})" title="Pin task">${pinIcon}</button>
                <button class="icon-btn" onclick="event.stopPropagation(); deleteTask(${task.id})">√ó</button>
              </div>
            </div>`;
          }).join('');
        }
      });

      updateStatsDisplay();
    }

    function openTaskModal(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      currentEditingTask = task;
      currentFocusTaskId = task.id;

      document.getElementById('modal-main-title').textContent = 'Edit Task';
      document.getElementById('modal-title').value = task.title;
      document.getElementById('modal-notes').value = task.notes || '';
      document.getElementById('modal-category').value = task.category;
      document.getElementById('modal-date').value = task.dueDate || '';
      document.getElementById('modal-time').value = task.dueTime || '';
      document.getElementById('modal-importance').value = task.importance;
      document.getElementById('modal-urgency').value = task.urgency;
      document.getElementById('modal-duration').value = task.estimatedDuration || '';
      document.getElementById('modal-recurring').checked = task.recurring || false;
      document.getElementById('modal-recur-frequency').value = task.recurFrequency || 'daily';
      document.getElementById('modal-recur-interval').value = task.recurInterval || 1;

      document.querySelectorAll('.weekday-check').forEach(cb => {
        cb.checked = (task.recurDays || []).includes(parseInt(cb.value));
      });

      toggleRecurringOptions();
      updateSliderValue('importance');
      updateSliderValue('urgency');
      renderTags();
      renderSubtasks();

      document.getElementById('modal-created').textContent = new Date(task.createdAt || Date.now()).toLocaleDateString();
      document.getElementById('modal-modified').textContent = new Date(task.modifiedAt || Date.now()).toLocaleDateString();
      document.getElementById('modal-status').textContent = task.status;
      const quadrantNames = { 'do-first': 'Do First', 'schedule': 'Schedule', 'delegate': 'Delegate', 'eliminate': 'Eliminate' };
      document.getElementById('modal-quadrant').textContent = quadrantNames[getQuad(task.importance, task.urgency)];

      document.getElementById('task-info-grid').style.display = 'grid';
      document.getElementById('delete-task-btn').style.display = 'block';

      document.getElementById('task-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeTaskModal() {
      document.getElementById('task-modal').classList.remove('active');
      document.body.style.overflow = 'auto';
      currentEditingTask = null;
    }

    function closeModalOnOverlay(event) {
      if (event.target.id === 'task-modal') closeTaskModal();
    }

    function updateSliderValue(type) {
      const value = document.getElementById('modal-' + type).value;
      document.getElementById(type + '-value').textContent = value;
    }

    function toggleRecurringOptions() {
      const isRecurring = document.getElementById('modal-recurring').checked;
      const options = document.getElementById('recurring-options');
      options.style.display = isRecurring ? 'block' : 'none';
      if (isRecurring) {
        updateRecurringUI();
      }
    }

    function updateRecurringUI() {
      const frequency = document.getElementById('modal-recur-frequency').value;
      document.getElementById('custom-days-input').style.display = frequency === 'custom' ? 'block' : 'none';
      document.getElementById('weekdays-input').style.display = frequency === 'weekly' ? 'block' : 'none';
    }

    function saveTaskDetails() {
      const title = document.getElementById('modal-title').value.trim();
      if (!title) return alert('Please enter a task title');

      const taskData = {
        title: title,
        notes: document.getElementById('modal-notes').value,
        category: document.getElementById('modal-category').value,
        dueDate: document.getElementById('modal-date').value,
        dueTime: document.getElementById('modal-time').value,
        importance: parseInt(document.getElementById('modal-importance').value),
        urgency: parseInt(document.getElementById('modal-urgency').value),
        estimatedDuration: parseInt(document.getElementById('modal-duration').value) || 0,
        recurring: document.getElementById('modal-recurring').checked,
        recurFrequency: document.getElementById('modal-recur-frequency').value,
        recurInterval: parseInt(document.getElementById('modal-recur-interval').value) || 1,
        recurDays: [],
        tags: currentEditingTask ? currentEditingTask.tags : [],
        subtasks: currentEditingTask ? currentEditingTask.subtasks : []
      };

      if (taskData.recurring && taskData.recurFrequency === 'weekly') {
        document.querySelectorAll('.weekday-check:checked').forEach(cb => {
          taskData.recurDays.push(parseInt(cb.value));
        });
      }

      if (currentEditingTask) {
        Object.assign(currentEditingTask, taskData);
        currentEditingTask.modifiedAt = new Date().toISOString();
      } else {
        const newTask = {
          id: Date.now(),
          ...taskData,
          status: 'todo',
          pinned: false,
          createdAt: new Date().toISOString(),
          modifiedAt: new Date().toISOString()
        };
        tasks.push(newTask);
      }

      saveTasks();
      render();
      updateStatsDisplay();
      closeTaskModal();
    }

    function deleteTaskFromModal() {
      if (!currentEditingTask) return;
      if (confirm('Delete this task?')) {
        tasks = tasks.filter(t => t.id !== currentEditingTask.id);
        if (currentUser) deleteTaskFromSupabase(currentEditingTask.id);
        saveTasks();
        render();
        updateStatsDisplay();
        closeTaskModal();
      }
    }

    function renderTags() {
      if (!currentEditingTask) return;
      const container = document.getElementById('tag-container');
      container.innerHTML = '';
      (currentEditingTask.tags || []).forEach(tag => {
        const tagEl = document.createElement('div');
        tagEl.className = 'tag';
        tagEl.innerHTML = tag + '<button class="tag-remove" onclick="removeTag(\'' + tag + '\')">√ó</button>';
        container.appendChild(tagEl);
      });
      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'tag-input';
      input.className = 'tag-input';
      input.placeholder = 'Add tags...';
      input.onkeypress = handleTagInput;
      container.appendChild(input);
    }

    function handleTagInput(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('tag-input');
        const tag = input.value.trim();
        if (tag && currentEditingTask) {
          if (!currentEditingTask.tags) currentEditingTask.tags = [];
          if (!currentEditingTask.tags.includes(tag)) {
            currentEditingTask.tags.push(tag);
            input.value = '';
            renderTags();
          }
        }
      }
    }

    function removeTag(tag) {
      if (!currentEditingTask) return;
      currentEditingTask.tags = currentEditingTask.tags.filter(t => t !== tag);
      renderTags();
    }

    function focusTagInput() {
      document.getElementById('tag-input').focus();
    }

    function renderSubtasks() {
      if (!currentEditingTask) return;
      const container = document.getElementById('subtask-list');
      if (!currentEditingTask.subtasks || currentEditingTask.subtasks.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:16px; font-size:14px;">No subtasks yet</div>';
        return;
      }
      container.innerHTML = currentEditingTask.subtasks.map((subtask, index) =>
        `<div class="subtask-item"><input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleSubtask(${index})"><span class="subtask-text ${subtask.completed ? 'completed' : ''}">${subtask.text}</span><button class="subtask-delete" onclick="deleteSubtask(${index})">√ó</button></div>`
      ).join('');
    }

    function handleSubtaskInput(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('subtask-input');
        const text = input.value.trim();
        if (text && currentEditingTask) {
          if (!currentEditingTask.subtasks) currentEditingTask.subtasks = [];
          currentEditingTask.subtasks.push({ text: text, completed: false });
          input.value = '';
          renderSubtasks();
        }
      }
    }

    function toggleSubtask(index) {
      if (!currentEditingTask) return;
      currentEditingTask.subtasks[index].completed = !currentEditingTask.subtasks[index].completed;
      renderSubtasks();
    }

    function deleteSubtask(index) {
      if (!currentEditingTask) return;
      currentEditingTask.subtasks.splice(index, 1);
      renderSubtasks();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Expose UI handlers for inline onclicks (module scope would otherwise hide them)
    Object.assign(window, {
      toggleTheme,
      toggleStatusDropdown,
      toggleMenu,
      closeMenu,
      toggleSearch,
      showAbout,
      toggleStatsPopup,
      closeStatsPopup,
      openNotesModal,
      closeNotesModal,
      closeNotesModalOnOverlay,
      toggleCompletedSection,
      handleQuickAdd,
      openAuthModal,
      closeAuthModal,
      toggleAuthMode,
      submitAuth,
      handleSignOut,
      openTaskModal,
      closeTaskModal,
      closeModalOnOverlay,
      saveTaskDetails,
      deleteTaskFromModal,
      toggleTaskStatus,
      deleteTask,
      togglePin,
      clearCompleted,
      importData,
      exportData,
      // Notes
      createNewNote,
      editNote,
      saveCurrentNote,
      deleteCurrentNote,
      convertNoteToTask,
      selectNoteColor,
      selectNoteCategory,
      switchNoteView,
      filterNotesByCategory,
      filterNotes,
      closeNoteEditModal,
      closeNoteEditModalOnOverlay,
      handleNoteKeydown,
      deleteNoteFromCard,
      // Notes helpers
      handleTagInput,
      handleSubtaskInput,
      toggleSubtask,
      deleteSubtask,
      focusTagInput,
      removeTag,
      // Task modal helpers
      toggleRecurringOptions,
      updateRecurringUI,
      updateSliderValue,
      // Drag/drop
      drag,
      dragEnd,
      allowDrop,
      drop,
      // Sorting/filters
      toggleSortDropdown,
      setSortMode,
      applyFilters,
      clearFilters,
      // Pomodoro
      openPomodoroModal,
      closePomodoroModal,
      openPomodoroSettings,
      closePomodoroSettings
    });

    // Add event listeners for floating badges
    document.getElementById('stats-badge').addEventListener('click', toggleStatsPopup);
    document.getElementById('notes-badge').addEventListener('click', openNotesModal);
  </script>
</body>

</html>
        
